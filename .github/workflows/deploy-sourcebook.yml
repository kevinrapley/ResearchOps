name: Deploy Sourcebook to Cloudflare Pages

on:
  push:
    branches: [ main ]
    paths:
      - "docs/devops/sourcebook/**"
      - ".github/workflows/deploy-sourcebook.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-publish
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: reops-sourcebook
          branch: main
          directory: docs/devops/sourcebook

      # Optional: ensure there's at least an index.html (nice safety net)
      - name: Ensure site has an index
        run: |
          if [ ! -f "docs/devops/sourcebook/index.html" ]; then
            cat > docs/devops/sourcebook/index.html <<'HTML'
            <!doctype html><meta charset="utf-8">
            <title>Sourcebook</title>
            <h1>Sourcebook site not generated for this run.</h1>
            HTML
          fi
