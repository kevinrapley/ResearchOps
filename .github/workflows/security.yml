name: Security & dependencies

on:
  schedule:
    - cron: "0 6 * * 1" # Mondays 06:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write # enables SARIF uploads for GitHub Security tab (optional)

concurrency:
  group: security-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Run audit in non-failing mode to avoid blocking builds,
      # but still capture actionable output.
      - name: Run npm audit (high severity and above)
        run: |
          npm audit --audit-level=high --json > npm-audit.json || true
          npm audit --audit-level=high || true

      # Optional: upload audit results for triage or retention
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit.json
          if-no-files-found: ignore

      # Optional: GitHub Security Dashboard integration (SARIF)
      - name: Convert audit report to SARIF
        if: always()
        run: npx audit2sarif npm-audit.json > npm-audit.sarif || true

      - name: Upload SARIF to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: npm-audit.sarif
