<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Project dashboard</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="stylesheet" href="/css/govuk/govuk-typography.css">
	<link rel="stylesheet" href="/css/govuk/govuk-colours.css">
	<link rel="stylesheet" href="/css/screen.css">
</head>

<body>
	<main id="app" class="govuk-width-container" data-project-id="">
		<header class="page-header">
			<h1 class="govuk-heading-l" id="project-title">Project dashboard</h1>
		</header>

		<section id="mural-setup" class="govuk-!-margin-top-4">
			<h2 class="govuk-heading-m">Reflexive journal board</h2>
			<p class="govuk-body" id="mural-status">Not created yet.</p>
			<div class="govuk-button-group">
				<button id="btn-mural-create" class="govuk-button" type="button" data-module="govuk-button">Create Mural board</button>
				<a id="mural-open" class="govuk-link" href="#" hidden>Open board</a>
			</div>
		</section>
	</main>

	<script>
		(function() {
			const qs = new URLSearchParams(location.search);
			const recId = (qs.get('id') || '').trim();
			const main = document.querySelector('main#app');
			if (recId) main.setAttribute('data-project-id', recId);

			// Optional: reflect in UI
			const title = document.getElementById('project-title');
			if (title && recId) title.textContent = `Project dashboard — ${recId}`;

			const btn = document.getElementById('btn-mural-create');
			const status = document.getElementById('mural-status');
			const openLink = document.getElementById('mural-open');

			async function postJSON(url, body) {
				const res = await fetch(url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(body)
				});
				const text = await res.text();
				let js = {};
				try { js = text ? JSON.parse(text) : {}; } catch {}
				return { ok: res.ok, status: res.status, data: js };
			}

			btn?.addEventListener('click', async () => {
				const projectId = main.getAttribute('data-project-id') || '';
				if (!projectId) {
					status.textContent = 'Missing project id.';
					return;
				}
				status.textContent = 'Creating board…';

				// You likely already have projectName available on the page.
				// If not, fall back to recId for now.
				const projectName = document.querySelector('[data-project-name]')?.getAttribute('data-project-name') || recId;

				const payload = {
					uid: 'anon', // or the signed-in user id you store in session
					projectId, // ← goes to Airtable "Project ID" (text field) via the service
					projectName
				};

				const resp = await postJSON('/api/mural/setup', payload);

				if (resp.ok && resp.data?.ok) {
					status.textContent = 'Board ready.';
					const url = resp.data.boardUrl || resp.data.mural?.viewLink || '';
					if (url) {
						openLink.href = url;
						openLink.hidden = false;
						openLink.textContent = 'Open board';
					}
				} else {
					const msg = resp.data?.message || resp.data?.error || `HTTP ${resp.status}`;
					status.textContent = `Failed to create board — ${msg}`;
				}
			});
		})();
	</script>
</body>

</html>
