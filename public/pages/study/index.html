<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Study — ResearchOps</title>

	<link rel="stylesheet" href="/css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="/css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="/css/screen.css" media="screen" />
	<script type="module" src="/components/layout.js"></script>
	<script type="module" src="study-desc-controller.js" defer></script>
</head>

<body>
	<x-include src="/partials/header.html" vars='{
    "active":"Projects",
    "subtitle":"Study"
  }'></x-include>

	<main class="govuk-body" role="main">
		<div class="actions-bar">
			<a id="back-to-project" href="/pages/projects/" class="btn btn--secondary">← Back to Project</a>
			<a id="edit-study" href="#" class="btn">✎ Edit Study</a>
		</div>

		<!-- Hero -->
		<div class="dashboard-hero">
			<p id="study-eyebrow" class="project-org"></p>
			<h1 id="study-title" class="govuk-heading-l">Study</h1>

			<!-- Description lives under the title -->
			<div id="desc-view-wrap">
				<div id="description" class="govuk-body">—</div>
				<div class="actions-bar" style="margin-top:8px;">
					<button id="btn-edit-desc" type="button" class="btn btn--outline">✎ Edit description</button>
				</div>
			</div>

			<!-- Inline editor (hidden by default) -->
			<form id="desc-editor" class="panel" hidden>
				<label class="govuk-label" for="desc-input">Description (Markdown)</label>
				<textarea id="desc-input" class="govuk-input" rows="8" spellcheck="true" autocomplete="off"></textarea>
				<div class="actions-bar" style="gap:8px;">
					<button class="btn" type="submit">Save</button>
					<button class="btn btn--secondary" id="desc-cancel" type="button">Cancel</button>
				</div>

				<!-- Allowed Markdown cheat sheet -->
				<details class="note" style="margin-top:8px;">
					<summary>Markdown cheat sheet (allowed)</summary>
					<div>
						<p>You can use a safe subset of Markdown:</p>
						<ul>
							<li>Headings: <code>#</code> … <code>######</code></li>
							<li>Bold / italic: <code>**bold**</code>, <code>*italic*</code></li>
							<li>Links: <code>[text](https://…)</code></li>
							<li>Lists:
								<ul>
									<li>Unordered: lines starting with <code>-</code>, <code>*</code> or <code>+</code></li>
									<li>Ordered: <code>1. item</code></li>
								</ul>
							</li>
							<li>Inline code: <code>`code`</code></li>
							<li>Code block: triple backticks <code>```</code></li>
							<li>Paragraphs: blank line between blocks</li>
						</ul>
					</div>
				</details>
			</form>
		</div>

		<!-- Key info -->
		<section class="kv">
			<ul class="kv__list">
				<li><span class="kv__term">Method</span>&nbsp;<span class="kv__desc" id="kv-method">–</span></li>
				<li><span class="kv__term">Status</span>&nbsp;<span class="kv__desc" id="kv-status">–</span></li>
				<li><span class="kv__term">Study ID</span>&nbsp;<span class="kv__desc" id="kv-studyid">–</span></li>
			</ul>
		</section>

		<!-- Materials hubs (placeholders) -->
		<nav class="board" aria-label="Study setup">
			<a href="#" class="board__item" aria-disabled="true">Produce consent forms</a>
			<a href="#" class="board__item" aria-disabled="true">Manage consent</a>
			<a href="#" class="board__item" aria-disabled="true">Schedule participants</a>
			<a href="#" class="board__item" aria-disabled="true">Discussion guides</a>
			<a href="#" class="board__item" aria-disabled="true">Note takers &amp; observers</a>
			<a href="#" class="board__item" aria-disabled="true">Begin a session</a>
		</nav>

		<!-- Overview kept for future content -->
		<section class="section">
			<header class="section__header">
				<h2 class="section__title govuk-heading-m">Overview</h2>
			</header>
			<div class="section__body">
				<div class="panel">
					<p class="govuk-body">Set up your study materials and workflows here.</p>
				</div>
			</div>
		</section>
	</main>

	<x-include src="/partials/footer.html" vars='{"org":"Home Office Biometrics","build":"ResearchOps v1.0.0 (demo)"}'></x-include>

	<script type="module">
		/**
		 * Study page bootstrap — minimal, reliable fetch + render from Worker API.
		 * Expects URL params: ?pid=<AirtableProjectId>&sid=<AirtableStudyRecordId>
		 * Uses: GET /api/studies?project=<pid>  → [{ id, studyId, method, status, description, createdAt }]
		 */

		// ── small helpers
		const $ = (sel, root = document) => root.querySelector(sel);
		const setText = (sel, val, fallback = "—") => {
			const el = $(sel);
			if (el) el.textContent = (val ?? "").toString().trim() || fallback;
		};

		// ── data access (Worker API proxies Airtable “Project Studies”)
		async function loadStudies(projectAirtableId) {
			const url = `/api/studies?project=${encodeURIComponent(projectAirtableId)}`;
			const res = await fetch(url, { cache: "no-store" });
			const js = await res.json().catch(() => ({}));
			if (!res.ok || js?.ok !== true || !Array.isArray(js.studies)) {
				throw new Error(js?.error || `Studies fetch failed (${res.status})`);
			}
			return js.studies;
		}

		// ── bootstrap
		(async function init() {
			try {
				const usp = new URLSearchParams(location.search);
				const pid = usp.get("pid") || ""; // Airtable Project record id
				const sid = usp.get("sid") || ""; // Airtable Study record id
				if (!pid || !sid) throw new Error("Missing pid or sid in URL");

				// Correct back-link for your /pages/ structure
				$("#back-to-project")?.setAttribute("href", `/pages/project-dashboard/?id=${encodeURIComponent(pid)}`);

				// Fetch studies for this project and pick the one we need
				const studies = await loadStudies(pid);
				console.debug("[study] fetched", studies.length, "studies for project", pid);
				const study = studies.find(s => s.id === sid);
				if (!study) throw new Error(`Study not found in project (sid=${sid})`);

				// Paint the UI (keep this dead simple first)
				setText("#study-eyebrow", "Study");
				setText("#study-title", study.method || "Study");
				setText("#kv-method", study.method || "");
				setText("#kv-status", study.status || "");
				setText("#kv-studyid", (study.studyId || "").toString().toUpperCase());

				// For now, show raw description plainly (no Markdown yet)
				const descEl = $("#description");
				if (descEl) descEl.textContent = (study.description || "").trim() || "—";

				// Optional “edit” deep link (stays on this page)
				$("#edit-study")?.setAttribute(
					"href",
					`/pages/study/?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}#edit`
				);

			} catch (err) {
				console.error("[study] init error:", err);
				alert("Could not load study.");
			}
		})();
	</script>

	<script type="module">
		/**
		 * @file study-bootstrap.js
		 * @summary Derive study id, set data-study-id, then wire the inline editor.
		 *
		 * Sources of truth (in order):
		 * 1) Existing DOM attribute (data-study-id on #study-root / main / body)
		 * 2) URL query param: sid (or id)
		 * 3) window.__STUDY?.id (if your page code sets it after fetching)
		 *
		 * Fails closed with clear console error.
		 */

		// ----- Config (no magic strings) -----
		const SEL_ROOTS = ['#study-root', 'main', 'body'];
		const ATTR_ID = 'data-study-id';
		const URL_KEYS = ['sid', 'id']; // adapt if you use another key
		const SAVE_URL = '/api/studies/:id';

		// ----- Utilities -----
		/** Find the root element we’ll annotate. */
		function getRoot() {
			for (const sel of SEL_ROOTS) {
				const el = document.querySelector(sel);
				if (el) return el;
			}
			return document.body;
		}

		/** Try to read an existing study id from DOM. */
		function readIdFromDom() {
			const root = getRoot();
			return root.getAttribute(ATTR_ID) || null;
		}

		/** Try to read study id from URL (?sid=rec... or ?id=rec...). */
		function readIdFromUrl() {
			const qs = new URLSearchParams(location.search);
			for (const key of URL_KEYS) {
				const v = qs.get(key);
				if (v && /^rec[a-zA-Z0-9]{14}$/i.test(v)) return v;
			}
			return null;
		}

		/** Try to read study id from a global your app may set. */
		function readIdFromGlobal() {
			// If your page fetch sets window.__STUDY = { id: 'rec...' }
			const v = (globalThis.__STUDY && globalThis.__STUDY.id) || null;
			return (typeof v === 'string' && v.startsWith('rec')) ? v : null;
		}

		/** Set the attribute on the chosen root. */
		function setDomId(id) {
			const root = getRoot();
			root.setAttribute(ATTR_ID, id);
			return root;
		}

		/** Initialise the editor once we have an id. */
		async function initEditor() {
			// Lazy import if you separated the class into its own module,
			// otherwise remove this and use the global/class already on the page.
			// import { StudyDescController } from './study-desc-controller.js';

			// If StudyDescController is already in scope (from earlier snippet), use it:
			if (typeof StudyDescController !== 'function') {
				console.error('StudyDescController not found on window or module scope.');
				return;
			}

			new StudyDescController({
				viewWrapSel: '#desc-view-wrap',
				viewSel: '#description',
				editBtnSel: '#btn-edit-desc',
				formSel: '#desc-editor',
				textareaSel: '#desc-input',
				cancelBtnSel: '#desc-cancel',
				saveUrl: SAVE_URL
			}).init();
		}

		// ----- Bootstrap flow -----
		(function bootstrap() {
			let id = readIdFromDom() || readIdFromUrl() || readIdFromGlobal();

			if (id) {
				setDomId(id);
				initEditor();
				return;
			}

			// If the id is not yet known (e.g. set later by your data loader),
			// observe for it to appear and then initialise exactly once.
			const root = getRoot();
			const mo = new MutationObserver(() => {
				const v = readIdFromDom();
				if (v) {
					mo.disconnect();
					initEditor();
				}
			});
			mo.observe(root, { attributes: true, attributeFilter: [ATTR_ID] });

			// Also listen for an app event you might emit after fetching.
			window.addEventListener('study:loaded', (e) => {
				const maybeId = e?.detail?.id;
				if (maybeId && !readIdFromDom()) {
					setDomId(maybeId);
					initEditor();
				}
			}, { once: true });

			// Last resort log (helps during integration)
			console.warn('study-bootstrap: study id not found yet; waiting for data-study-id attribute or study:loaded event.');
		})();
	</script>
</body>

</html>
