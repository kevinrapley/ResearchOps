<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Study — ResearchOps</title>

	<link rel="stylesheet" href="/css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="/css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="/css/screen.css" media="screen" />
	<script type="module" src="/components/layout.js"></script>
</head>

<body>
	<x-include src="/partials/header.html" vars='{
    "active":"Projects",
    "subtitle":"Study"
  }'></x-include>

	<main class="govuk-body" role="main">
		<div class="actions-bar">
			<a id="back-to-project" href="/pages/projects/" class="btn btn--secondary">← Back to Project</a>
			<a id="edit-study" href="#" class="btn">✎ Edit Study</a>
		</div>

		<!-- Hero -->
		<div class="dashboard-hero">
			<p id="study-eyebrow" class="project-org"></p>
			<h1 id="study-title" class="govuk-heading-l">Study</h1>

			<!-- Description lives under the title -->
			<div id="desc-view-wrap">
				<div id="description" class="govuk-body">—</div>
				<div class="actions-bar" style="margin-top:8px;">
					<button id="btn-edit-desc" type="button" class="btn btn--outline">✎ Edit description</button>
				</div>
			</div>

			<!-- Inline editor (hidden by default) -->
			<form id="desc-editor" class="panel" hidden>
				<label class="govuk-label" for="desc-input">Description (Markdown)</label>
				<textarea id="desc-input" class="govuk-input" rows="8" spellcheck="true" autocomplete="off"></textarea>
				<div class="actions-bar" style="gap:8px;">
					<button class="btn" type="submit">Save</button>
					<button class="btn btn--secondary" id="desc-cancel" type="button">Cancel</button>
				</div>

				<!-- Allowed Markdown cheat sheet -->
				<details class="note" style="margin-top:8px;">
					<summary>Markdown cheat sheet (allowed)</summary>
					<div>
						<p>You can use a safe subset of Markdown:</p>
						<ul>
							<li>Headings: <code>#</code> … <code>######</code></li>
							<li>Bold / italic: <code>**bold**</code>, <code>*italic*</code></li>
							<li>Links: <code>[text](https://…)</code></li>
							<li>Lists:
								<ul>
									<li>Unordered: lines starting with <code>-</code>, <code>*</code> or <code>+</code></li>
									<li>Ordered: <code>1. item</code></li>
								</ul>
							</li>
							<li>Inline code: <code>`code`</code></li>
							<li>Code block: triple backticks <code>```</code></li>
							<li>Paragraphs: blank line between blocks</li>
						</ul>
					</div>
				</details>
			</form>
		</div>

		<!-- Key info -->
		<section class="kv">
			<ul class="kv__list">
				<li><span class="kv__term">Method</span>&nbsp;<span class="kv__desc" id="kv-method">–</span></li>
				<li><span class="kv__term">Status</span>&nbsp;<span class="kv__desc" id="kv-status">–</span></li>
				<li><span class="kv__term">Study ID</span>&nbsp;<span class="kv__desc" id="kv-studyid">–</span></li>
			</ul>
		</section>

		<!-- Materials hubs (placeholders) -->
		<nav class="board" aria-label="Study setup">
			<a href="#" class="board__item" aria-disabled="true">Produce consent forms</a>
			<a href="#" class="board__item" aria-disabled="true">Manage consent</a>
			<a href="#" class="board__item" aria-disabled="true">Schedule participants</a>
			<a href="#" class="board__item" aria-disabled="true">Discussion guides</a>
			<a href="#" class="board__item" aria-disabled="true">Note takers &amp; observers</a>
			<a href="#" class="board__item" aria-disabled="true">Begin a session</a>
		</nav>

		<!-- Overview kept for future content -->
		<section class="section">
			<header class="section__header">
				<h2 class="section__title govuk-heading-m">Overview</h2>
			</header>
			<div class="section__body">
				<div class="panel">
					<p class="govuk-body">Set up your study materials and workflows here.</p>
				</div>
			</div>
		</section>
	</main>

	<x-include src="/partials/footer.html" vars='{"org":"Home Office Biometrics","build":"ResearchOps v1.0.0 (demo)"}'></x-include>

	<script type="module">
		/**
		 * Minimal, battle-tested bootstrap:
		 * - Reads ?pid & ?sid
		 * - GETs /api/studies?project=pid
		 * - Finds study by sid
		 * - Renders Method/Status/Study ID + Markdown description
		 * - Emits clear console + on-page debug if anything fails
		 */

		const $ = (s, r = document) => r.querySelector(s);
		const setText = (sel, v, fallback = "—") => { const el = $(sel); if (el) el.textContent = (v ?? "").toString().trim() || fallback; };

		// ultra-safe Markdown subset (no fancy regex that could break)
		function esc(s) { return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;"); }

		function mdToHtml(md) {
			let t = String(md ?? "").replace(/\r\n?/g, "\n");
			t = t.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${esc(code.trim())}</code></pre>`);
			t = t.replace(/`([^`]+?)`/g, (_, code) => `<code>${esc(code)}</code>`);
			t = t.replace(/^(#{1,6})[ \t]+(.+)$/gm, (_, h, txt) => `<h${h.length}>${esc(txt.trim())}</h${h.length}>`);
			t = t.replace(/\*\*([^*]+?)\*\*/g, "<strong>$1</strong>").replace(/\*([^*]+?)\*/g, "<em>$1</em>");
			t = t.replace(/$begin:math:display$([^$end:math:display$]+?)\]$begin:math:text$(https?:\\/\\ / [ ^ \\s)] + ) $end: math: text$ / g, (_, label, url) => `<a class="govuk-link" href="${esc(url)}" target="_blank" rel="noopener noreferrer">${esc(label)}</a>`);
		const blocks = t.split(/\n{2,}/).map(b => b.trim()).filter(Boolean).map(b => /^<(h\d|ul|ol|pre)/.test(b) ? b : `<p>${b.replace(/\n/g,"<br>")}</p>`);
		return blocks.join("\n");
		}

		function setMarkdown(selector, md) {
			const el = $(selector);
			if (!el) return;
			try { el.innerHTML = mdToHtml(md); } catch (err) { console.error("Markdown failed:", err);
				el.textContent = String(md ?? ""); }
		}

		(function init() {
			// add a tiny on-page debug area
			const dbg = document.createElement("pre");
			dbg.id = "debug";
			dbg.style.whiteSpace = "pre-wrap";
			dbg.style.fontSize = "12px";
			dbg.style.opacity = "0.7";
			document.body.appendChild(dbg);
			const log = (...a) => { console.log(...a); try { dbg.textContent += a.map(x => typeof x === "string" ? x : JSON.stringify(x, null, 2)).join(" ") + "\n"; } catch {} };

			const usp = new URLSearchParams(location.search);
			const pid = usp.get("pid") || "";
			const sid = usp.get("sid") || "";
			if (!pid || !sid) { log("Missing pid or sid", { pid, sid });
				setText("#study-title", "Study");
				setText("#kv-method", "—");
				setText("#kv-status", "—");
				setText("#kv-studyid", "—"); return; }

			// make sure links work from /pages/study/
			$("#back-to-project")?.setAttribute("href", `/pages/project-dashboard/?id=${encodeURIComponent(pid)}`);
			$("#edit-study")?.setAttribute("href", `/pages/study/?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}#edit`);

			const url = `/api/studies?project=${encodeURIComponent(pid)}`;
			log("Fetching:", url);

			fetch(url, { cache: "no-store" })
				.then(async res => {
					const js = await res.json().catch(() => ({}));
					log("API status:", res.status, "payload.ok:", js?.ok);
					if (!res.ok || !js?.ok) { throw new Error(js?.error || `HTTP ${res.status}`); }
					const studies = Array.isArray(js.studies) ? js.studies : [];
					log("studies length:", studies.length);

					const study = studies.find(s => s.id === sid);
					if (!study) { throw new Error(`Study not found for sid=${sid}`); }

					// render
					setText("#study-eyebrow", "Study");
					setText("#study-title", study.method || "Study");
					setText("#kv-method", study.method || "—");
					setText("#kv-status", study.status || "—");
					setText("#kv-studyid", (study.studyId || "").toString().toUpperCase() || "—");
					setMarkdown("#description", study.description || "—");

					log("Rendered study:", { id: study.id, method: study.method, status: study.status });
				})
				.catch(err => {
					console.error(err);
					log("ERROR:", String(err && err.message || err));
					setText("#study-title", "Study");
					setText("#kv-method", "—");
					setText("#kv-status", "—");
					setText("#kv-studyid", "—");
					const desc = $("#description");
					if (desc) desc.textContent = "Could not load study.";
				});
		})();
	</script>
</body>

</html>
