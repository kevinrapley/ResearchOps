<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Study ‚Äî Participants</title>

	<link rel="stylesheet" href="/css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="/css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="/css/screen.css" media="screen" />
	<link rel="stylesheet" href="/css/participants.css" media="screen" />

	<script type="module" src="/components/layout.js"></script>
	<!-- NEW: wire the participants page module -->
	<script type="module" src="/components/participants/participants-page.js" defer></script>
	<script type="module" src="/pages/study/participants/scheduler.js" defer></script>
</head>

<body>
	<!-- Debug Console (iPad-friendly) -->
	<style>
		/* === DEBUG CONSOLE (iPad-friendly) ========================= */

		.debug-toggle {
			position: fixed;
			bottom: 20px;
			right: 20px;
			width: 56px;
			height: 56px;
			border-radius: 50%;
			background: #d4351c;
			color: white;
			border: none;
			font-size: 24px;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			z-index: 9998;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.debug-toggle:active {
			transform: scale(0.95);
		}

		.debug-console {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			height: 40vh;
			background: #1a1a1a;
			color: #0f0;
			font-family: 'Courier New', monospace;
			font-size: 12px;
			z-index: 9999;
			display: flex;
			flex-direction: column;
			box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5);
		}

		.debug-console[hidden] {
			display: none;
		}

		.debug-console__header {
			background: #0b0c0c;
			color: white;
			padding: 12px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			border-bottom: 1px solid #333;
		}

		.debug-console__header span {
			font-weight: bold;
		}

		.debug-console__btn {
			background: #d4351c;
			color: white;
			border: none;
			padding: 6px 12px;
			border-radius: 4px;
			margin-left: 8px;
			cursor: pointer;
			font-size: 12px;
		}

		.debug-console__btn:active {
			background: #b02d17;
		}

		.debug-console__output {
			flex: 1;
			overflow-y: auto;
			padding: 12px;
			-webkit-overflow-scrolling: touch;
		}

		.debug-log {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #0f0;
			background: rgba(0, 255, 0, 0.05);
		}

		.debug-error {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #d4351c;
			background: rgba(212, 53, 28, 0.1);
			color: #ff6b6b;
		}

		.debug-warn {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #ffdd00;
			background: rgba(255, 221, 0, 0.1);
			color: #ffdd00;
		}

		.debug-info {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #1d70b8;
			background: rgba(29, 112, 184, 0.1);
			color: #5bc0de;
		}

		.debug-timestamp {
			color: #666;
			font-size: 10px;
			margin-right: 8px;
		}

		@media (min-width: 768px) {
			.debug-console {
				right: 0;
				left: auto;
				width: 400px;
				height: 60vh;
			}
		}
	</style>
	<script>
		/**
		 * @file participants-page-debug.js
		 */

		(function() {
			const logs = [];
			const maxLogs = 100;

			function addLog(type, args) {
				const timestamp = new Date().toLocaleTimeString();
				const message = Array.from(args).map(arg => {
					if (arg instanceof Error) {
						const name = arg.name || "Error";
						const msg = arg.message || String(arg);
						const stk = arg.stack ? `\n${arg.stack}` : "";
						return `${name}: ${msg}${stk}`;
					}
					if (typeof arg === 'object' && arg !== null) {
						try { return JSON.stringify(arg, null, 2); } catch { return String(arg); }
					}
					return String(arg);
				}).join(' ');

				logs.push({ type, timestamp, message });
				if (logs.length > maxLogs) logs.shift();

				const output = document.getElementById('debug-output');
				if (output) {
					const entry = document.createElement('div');
					entry.className = `debug-${type}`;
					entry.innerHTML = `<span class="debug-timestamp">${timestamp}</span>${escapeHtml(message)}`;
					output.appendChild(entry);
					output.scrollTop = output.scrollHeight;
				}
			}

			const originalLog = console.log;
			const originalError = console.error;
			const originalWarn = console.warn;
			const originalInfo = console.info;

			console.log = function() {
				originalLog.apply(console, arguments);
				addLog('log', arguments);
			};
			console.error = function() {
				originalError.apply(console, arguments);
				addLog('error', arguments);
			};
			console.warn = function() {
				originalWarn.apply(console, arguments);
				addLog('warn', arguments);
			};
			console.info = function() {
				originalInfo.apply(console, arguments);
				addLog('info', arguments);
			};

			window.addEventListener('error', function(e) {
				addLog('error', [`üí• ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`]);
			});
			window.addEventListener('unhandledrejection', function(e) {
				addLog('error', [`‚ö†Ô∏è Unhandled Promise: ${e.reason}`]);
			});

			window.addEventListener('DOMContentLoaded', function() {
				const toggle = document.getElementById('debug-toggle');
				const debugConsole = document.getElementById('debug-console');
				const closeBtn = document.getElementById('debug-close');
				const clearBtn = document.getElementById('debug-clear');

				if (toggle && debugConsole) toggle.addEventListener('click', () => { debugConsole.hidden = !debugConsole.hidden; });
				if (closeBtn && debugConsole) closeBtn.addEventListener('click', () => { debugConsole.hidden = true; });
				if (clearBtn) clearBtn.addEventListener('click', () => {
					logs.length = 0;
					const output = document.getElementById('debug-output');
					if (output) output.innerHTML = '';
				});

				console.log('üêõ Debug console initialized');
			});

			function escapeHtml(str) {
				const div = document.createElement('div');
				div.textContent = str;
				return div.innerHTML;
			}
		})();
	</script>
	<div id="debug-console" class="debug-console" hidden>
		<div class="debug-console__header">
			<span>üêõ Debug Console</span>
			<button id="debug-clear" class="debug-console__btn">Clear</button>
			<button id="debug-close" class="debug-console__btn">Close</button>
		</div>
		<div id="debug-output" class="debug-console__output"></div>
	</div>
	<button id="debug-toggle" class="debug-toggle">üêõ</button>

	<!-- Rest of your page continues here -->
	<x-include src="/partials/header.html" vars='{
    "active":"Projects",
    "subtitle":"Study ‚Äî Participants"
  }'></x-include>

	<main id="main" class="container govuk-body" role="main">
		<!-- Breadcrumb -->
		<nav class="breadcrumbs" aria-label="Breadcrumb">
			<ol>
				<li><a href="/pages/projects/">Projects</a></li>
				<li><a id="breadcrumb-project" href="#">Project</a></li>
				<li><a id="breadcrumb-study" href="#">Study</a></li>
				<li aria-current="page">Participants</li>
			</ol>
		</nav>

		<div class="govuk-!-margin-bottom-4">
			<strong id="studyBadge" class="badge">Study:</strong>
		</div>

		<!-- Participants row -->
		<div class="govuk-grid-row govuk-!-margin-bottom-7">
			<!-- Left: table or empty state -->
			<div class="govuk-grid-column-one-half">
				<section aria-labelledby="participants-h">
					<h2 id="participants-h" class="govuk-heading-l govuk-!-margin-bottom-3">Participants</h2>
					<p class="govuk-hint">Invite and manage participants for this study.</p>

					<!-- Empty state (hidden when there are participants) -->
					<div id="participantsEmpty" class="empty card" hidden>
						<h3 class="govuk-heading-m govuk-!-margin-bottom-2">No participants yet</h3>
						<p>Add your first participant to begin scheduling sessions.</p>
						<a href="#addParticipantForm" class="btn btn--primary">Add a participant</a>
					</div>

					<!-- NEW: Semantic table target for the module -->
					<div class="table-wrap" id="participantsTableWrap" hidden>
						<table class="table" role="table" aria-label="Participants">
							<thead>
								<tr>
									<th scope="col">Name</th>
									<th scope="col">Email</th>
									<th scope="col">Phone</th>
									<th scope="col">Channel</th>
									<th scope="col">Status</th>
								</tr>
							</thead>
							<tbody id="participants-tbody">
								<tr>
									<td colspan="5" class="muted">Loading‚Ä¶</td>
								</tr>
							</tbody>
						</table>
					</div>
				</section>
			</div>

			<!-- Right: Add participant -->
			<div class="govuk-grid-column-one-half">
				<section class="card" aria-labelledby="addp-h">
					<h2 id="addp-h" class="govuk-heading-l govuk-!-margin-bottom-3">Add participant</h2>

					<form id="addParticipantForm" class="form" novalidate>
						<div class="govuk-form-group">
							<label class="govuk-label" for="p_display">Display name</label>
							<input class="govuk-input" id="p_display" name="display_name" required autocomplete="off" />
						</div>

						<div class="govuk-grid-row">
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="p_email">Email</label>
									<input class="govuk-input" id="p_email" name="email" type="email" autocomplete="off" />
								</div>
							</div>
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="p_phone">Phone</label>
									<input class="govuk-input" id="p_phone" name="phone" autocomplete="off" />
								</div>
							</div>
						</div>

						<div class="govuk-form-group">
							<label class="govuk-label" for="p_channel">Channel preference</label>
							<select class="govuk-select" id="p_channel" name="channel_pref">
								<option value="email">email</option>
								<option value="sms">sms</option>
							</select>
						</div>

						<div class="govuk-form-group">
							<label class="govuk-label" for="p_access">Access needs (optional)</label>
							<textarea class="govuk-textarea" id="p_access" name="access_needs" rows="2"></textarea>
						</div>

						<div class="form__actions">
							<button class="govuk-button" type="submit" data-module="govuk-button">Create participant</button>
							<span id="addParticipantMsg" class="msg" role="status" aria-live="polite"></span>
						</div>
					</form>
				</section>
			</div>
		</div>

		<!-- Sessions row -->
		<div class="govuk-grid-row">
			<!-- Left: table or empty state -->
			<div class="govuk-grid-column-one-half">
				<section aria-labelledby="sessions-h">
					<h2 id="sessions-h" class="govuk-heading-l govuk-!-margin-bottom-3">Sessions</h2>
					<p class="govuk-hint">Scheduled sessions for this study. Download calendar invites as <code>.ics</code>.</p>

					<!-- Empty state (hidden when sessions exist) -->
					<div id="sessionsEmpty" class="empty card" hidden>
						<h3 class="govuk-heading-m govuk-!-margin-bottom-2">No sessions yet</h3>
						<p>Schedule a session once you‚Äôve added at least one participant.</p>
						<a href="#scheduleForm" class="btn btn--primary" id="scheduleCta">Schedule a session</a>
					</div>

					<!-- Table (hidden when none) -->
					<div class="table card" id="sessionsTable" role="table" aria-label="Sessions" hidden>
						<div class="rowh table__header" role="row">
							<div role="columnheader">When</div>
							<div role="columnheader">Participant</div>
							<div role="columnheader">Status</div>
							<div role="columnheader">Actions</div>
						</div>
						<!-- rows injected by scheduler.js -->
					</div>
				</section>
			</div>

			<!-- Right: Schedule session -->
			<div class="govuk-grid-column-one-half">
				<section class="card" aria-labelledby="schedules-h">
					<h2 id="schedules-h" class="govuk-heading-l govuk-!-margin-bottom-3">Schedule a session</h2>

					<!-- Info banner if no participants; form will be disabled -->
					<div id="noParticipantsBanner" class="note" role="status" hidden>
						Add at least one participant to enable scheduling.
					</div>

					<form id="scheduleForm" class="form" novalidate>
						<div class="govuk-grid-row">
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="s_participant">Participant</label>
									<select class="govuk-select" id="s_participant" required></select>
								</div>
							</div>
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="s_type">Type</label>
									<select class="govuk-select" id="s_type">
										<option value="remote">remote</option>
										<option value="in-person">in-person</option>
									</select>
								</div>
							</div>
						</div>

						<div class="govuk-grid-row">
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="s_datetime">Start (local)</label>
									<input class="govuk-input" id="s_datetime" type="datetime-local" required />
								</div>
							</div>
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="s_duration">Duration (min)</label>
									<input class="govuk-input" id="s_duration" type="number" min="15" step="5" value="60" required />
								</div>
							</div>
						</div>

						<div class="govuk-form-group">
							<label class="govuk-label" for="s_location">Location / Join link</label>
							<input class="govuk-input" id="s_location" required />
						</div>

						<div class="govuk-grid-row">
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="s_backup">Backup contact</label>
									<input class="govuk-input" id="s_backup" />
								</div>
							</div>
							<div class="govuk-grid-column-one-half">
								<div class="govuk-form-group">
									<label class="govuk-label" for="s_researchers">Researchers</label>
									<input class="govuk-input" id="s_researchers" />
								</div>
							</div>
						</div>

						<div class="govuk-form-group">
							<label class="govuk-label" for="s_notes">Notes</label>
							<textarea class="govuk-textarea" id="s_notes" rows="2"></textarea>
						</div>

						<div class="form__actions">
							<button id="scheduleBtn" class="govuk-button" type="submit" data-module="govuk-button">Create session</button>
							<span id="scheduleMsg" class="msg" role="status" aria-live="polite"></span>
						</div>
					</form>
				</section>
			</div>
		</div>
	</main>

	<x-include src="/partials/footer.html"></x-include>

	<!-- NEW: Page glue for breadcrumbs + empty/table toggle -->
	<script type="module">
		/**
		 * @file participants-page.glue.js (Safari-safe)
		 * - Sets breadcrumb + badge text
		 * - Listens for participants-rendered / participants_rendered
		 * - Toggles empty state vs table without throwing
		 */
		const $ = (s, r = document) => r.querySelector(s);

		function fallbackTitle(s = {}) {
			const method = (s.method || "Study").trim();
			const d = s.createdAt ? new Date(s.createdAt) : new Date();
			const yyyy = d.getUTCFullYear();
			const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
			const dd = String(d.getUTCDate()).padStart(2, "0");
			return `${method} ‚Äî ${yyyy}-${mm}-${dd}`;
		}

		function pickTitle(s = {}) { return (s.title || s.Title || "").trim() || fallbackTitle(s); }

		async function getProject(pid) {
			const r = await fetch(`/api/projects/${encodeURIComponent(pid)}`, { cache: "no-store" });
			try { return r.ok ? await r.json() : {}; } catch { return {}; }
		}
		async function getStudies(pid) {
			const r = await fetch(`/api/studies?project=${encodeURIComponent(pid)}`, { cache: "no-store" });
			const js = await r.json().catch(() => ({}));
			return js?.ok && Array.isArray(js.studies) ? js.studies : [];
		}

		(function init() {
			try {
				const usp = new URLSearchParams(location.search);
				const pid = usp.get("pid") || "";
				const sid = usp.get("sid") || "";
				if (!pid || !sid) throw new Error("Missing pid or sid in URL");

				Promise.all([getProject(pid), getStudies(pid)]).then(([project, studies]) => {
					const study = Array.isArray(studies) ? (studies.find(s => s.id === sid) || {}) : {};

					// Breadcrumbs (guarded)
					const bcProj = $("#breadcrumb-project");
					if (bcProj) {
						bcProj.setAttribute("href", `/pages/project-dashboard/?id=${encodeURIComponent(pid)}`);
						bcProj.textContent = project?.name || "Project";
					}
					const bcStudy = $("#breadcrumb-study");
					if (bcStudy) {
						bcStudy.setAttribute("href", `/pages/study/?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}`);
						bcStudy.textContent = pickTitle(study);
					}

					// Badge
					const badge = $("#studyBadge");
					if (badge) badge.textContent = `Study: ${pickTitle(study)}`;

					// Toggle helpers
					const $empty = $("#participantsEmpty");
					const $table = $("#participantsTable");
					const noP = $("#noParticipantsBanner");
					const sel = $("#s_participant");
					const btn = $("#scheduleBtn");

					function applyCount(n) {
						const has = n > 0;
						if ($empty) $empty.hidden = has;
						if ($table) $table.hidden = !has;
						if (noP) noP.hidden = has;
						if (sel) sel.disabled = !has;
						if (btn) btn.disabled = !has;
					}

					// Listen to Safari-safe event names
					const onRendered = (e) => {
						const n = e?.detail?.count ?? 0;
						console.info("[participants] rendered count =", n);
						applyCount(n);
					};
					window.addEventListener("participants-rendered", onRendered);
					window.addEventListener("participants_rendered", onRendered);

					// If the renderer fired before we attached listeners, check table now
					// (participants-page.js shows/hides #participantsTable; we mirror that)
					const lateHasRows = $table && !$table.hidden;
					if (lateHasRows) applyCount(($table.querySelectorAll(".row").length || 1));

				}).catch(err => {
					console.error("[participants] glue async error:", err);
				});

			} catch (err) {
				// Previous ‚Äústring did not match the expected pattern‚Äù showed up here in Safari.
				// We guard everything above and never use colon-based event names in glue.
				console.error("[participants] glue init error:", err);
			}
		})();
	</script>
</body>

</html>
