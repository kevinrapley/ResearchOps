<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Discussion Guides ‚Äî Study</title>

	<link rel="stylesheet" href="/css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="/css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="/css/screen.css" media="screen" />
	<link rel="stylesheet" href="/css/guides.css" media="screen" />

	<script type="module" src="/components/layout.js"></script>
	<script type="module" src="/components/guides/guides-page.js" defer></script>
</head>

<body>
	<x-include src="/partials/header.html" vars='{
		"active":"Projects",
		"subtitle":"Study ‚Äî Discussion Guides"
	}'></x-include>

	<main id="main" class="container govuk-body" role="main">
		<script>
(async () => {
  const pid = new URLSearchParams(location.search).get("pid");
  const sid = new URLSearchParams(location.search).get("sid");
  const out = document.createElement("pre");
  out.style.background = "#fff5cc";
  out.style.padding = "8px";
  out.style.whiteSpace = "pre-wrap";
  out.textContent = "üîç Checking known guide endpoints‚Ä¶";
  document.body.appendChild(out);

  const eps = [
    `/api/guides`,
    `/api/guides?study=${sid}`,
    `/api/studies/${sid}/guides`,
    `/api/studies/${sid}/guides/${sid}`,
    `/api/projects/${pid}/guides`,
    `/api/projects/${pid}/studies/${sid}/guides`,
    `/api/study-guides?study=${sid}`,
    `/api/guide?study=${sid}`,
    `/api/guide/${sid}`
  ];

  for (const ep of eps) {
    try {
      const res = await fetch(ep);
      const txt = await res.text();
      out.textContent += `\n\n${ep}\n${res.status}: ${txt.slice(0, 400)}`;
    } catch (err) {
      out.textContent += `\n\n${ep}\nERROR: ${err.message}`;
    }
  }
})();
</script>
		<!-- Breadcrumb -->
		<nav class="breadcrumbs" aria-label="Breadcrumb">
			<ol>
				<li><a href="/pages/projects/">Projects</a></li>
				<li><a id="breadcrumb-project" href="#">Project</a></li>
				<li><a id="breadcrumb-study" href="#">Study</a></li>
				<li aria-current="page">Guides</li>
			</ol>
		</nav>

		<!-- Header -->
		<header class="page-header">
			<div class="page-header__titles">
				<h1 class="govuk-heading-l">Discussion Guides</h1>
				<p id="study-subtitle" class="muted">Study: <span id="study-title" data-bind="study.title">‚Äî</span></p>
			</div>

			<div class="page-header__actions" role="toolbar" aria-label="Guide actions">
				<button id="btn-new" class="btn">Ôºã New guide</button>
				<button id="btn-import" class="btn btn--secondary">‚§í Import .md</button>
				<a id="back-to-study" class="btn btn--secondary" href="#">‚Üê Back to Study</a>
			</div>
		</header>

		<section id="guides-list-section" aria-labelledby="guides-list-title">
			<h2 id="guides-list-title" class="govuk-heading-m">Guides for this study</h2>

			<div class="table-wrap">
				<table class="table" role="table">
					<thead>
						<tr>
							<th scope="col">Title</th>
							<th scope="col">Status</th>
							<th scope="col">Version</th>
							<th scope="col">Updated</th>
							<th scope="col">Owner</th>
							<th scope="col"><span class="sr-only">Actions</span></th>
						</tr>
					</thead>
					<tbody id="guides-tbody">
						<tr>
							<td colspan="6" class="muted">Loading‚Ä¶</td>
						</tr>
					</tbody>
				</table>
			</div>
		</section>

		<hr class="divider" />

		<section id="editor-section" class="editor is-hidden" aria-labelledby="editor-title">
			<div class="editor__header">
				<h2 id="editor-title" class="govuk-heading-m">Guide editor</h2>
				<div class="editor__meta">
					<label for="guide-title" class="sr-only">Guide title</label>
					<input id="guide-title" name="guide-title" class="input input--title" placeholder="Untitled guide" />
					<span id="guide-status" class="tag" aria-live="polite">draft</span>
				</div>

				<div class="editor__toolbar" role="toolbar" aria-label="Editor actions">
					<button id="btn-insert-tag" class="btn btn--secondary">Tag</button>
					<button id="btn-insert-pattern" class="btn btn--secondary">Pattern</button>
					<button id="btn-variables" class="btn btn--secondary">Variables</button>
					<div class="toolbar-spacer" aria-hidden="true"></div>
					<button id="btn-save" class="btn">üíæ Save</button>
					<button id="btn-publish" class="btn btn--primary">‚¨Ü Publish</button>
					<div class="menu">
						<button id="btn-export" class="btn btn--secondary" aria-haspopup="true" aria-expanded="false">Export</button>
						<ul id="export-menu" class="menu__list" role="menu" aria-label="Export as">
							<li role="menuitem"><button data-export="md">Markdown (.md)</button></li>
							<li role="menuitem"><button data-export="html">HTML (.html)</button></li>
							<li role="menuitem"><button data-export="pdf">PDF (.pdf)</button></li>
							<li role="menuitem"><button data-export="docx">Docx (.docx)</button></li>
						</ul>
					</div>
				</div>
			</div>

			<div class="editor__split" aria-label="Source and preview">
				<section class="pane pane--source" aria-labelledby="source-title">
					<h3 id="source-title" class="govuk-heading-s">Source (Markdown + Mustache)</h3>
					<textarea id="guide-source" class="code" spellcheck="false" aria-describedby="lint-output"></textarea>
					<div id="lint-output" class="lint" role="status" aria-live="polite"></div>
				</section>

				<section class="pane pane--preview" aria-labelledby="preview-title">
					<h3 id="preview-title" class="govuk-heading-s">Live preview</h3>
					<article id="guide-preview" class="preview" role="document" tabindex="0">
						<p class="muted">Start typing to see a preview‚Ä¶</p>
					</article>
				</section>
			</div>

			<aside id="drawer-patterns" class="drawer" aria-labelledby="drawer-patterns-title" hidden>
				<h3 id="drawer-patterns-title" class="govuk-heading-s">Pattern library</h3>
				<input id="pattern-search" class="input" placeholder="Search patterns" />
				<ul id="pattern-list" class="list-plain"></ul>
				<button id="drawer-patterns-close" class="link-like">Close</button>
			</aside>

			<aside id="drawer-variables" class="drawer" aria-labelledby="drawer-variables-title" hidden>
				<h3 id="drawer-variables-title" class="govuk-heading-s">Variables</h3>
				<form id="variables-form" class="form-grid" aria-describedby="variables-help">
					<p id="variables-help" class="muted">Edit front-matter without hand writing YAML.</p>
				</form>
				<button id="drawer-variables-close" class="link-like">Close</button>
			</aside>
		</section>

		<div id="sr-live" class="sr-only" aria-live="polite"></div>
		<section id="debug-panel" hidden class="debug-panel">
			<h3>Debug output</h3>
			<pre id="debug-output" class="debug-output">Debugging disabled.</pre>
			<style>
			.debug-panel {
				margin-top: 24px;
				padding: 12px;
				background: #f3f2f1;
				border: 1px solid #b1b4b6;
				overflow-x: auto;
				white-space: pre-wrap;
				font-family: monospace;
				}
			</style>
		</section>
	</main>

	<x-include src="/partials/footer.html"></x-include>

	<script type="module">
		/**
		 * @file /pages/study/guides/index.html
		 * @module GuidesPage
		 * @summary Fetches project + study data, ensuring a valid title is always shown.
		 * @description
		 * - Title uses `study.title || study.Title || Method ‚Äî YYYY-MM-DD`.
		 * - Binds study name into breadcrumb and header subtitle.
		 * - Routes ‚ÄúBack to Study‚Äù to `/pages/study/?pid=‚Ä¶&sid=‚Ä¶`.
		 */

		const $ = (s, r = document) => r.querySelector(s);

		/**
		 * Compute fallback ‚ÄúMethod ‚Äî YYYY-MM-DD‚Äù title for studies missing a title field.
		 * @param {{ method?: string, createdAt?: string }} s
		 * @returns {string}
		 */
		function fallbackTitle(s = {}) {
			const method = (s.method || "Study").trim();
			const d = s.createdAt ? new Date(s.createdAt) : new Date();
			const yyyy = d.getUTCFullYear();
			const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
			const dd = String(d.getUTCDate()).padStart(2, "0");
			return `${method} ‚Äî ${yyyy}-${mm}-${dd}`;
		}

		/**
		 * Pick the best available title.
		 * @param {{ title?: string, Title?: string, method?: string, createdAt?: string }} s
		 * @returns {string}
		 */
		function pickTitle(s = {}) {
			return (s.title || s.Title || "").trim() || fallbackTitle(s);
		}

		/**
		 * Load studies for a project from the Worker API.
		 * @param {string} projectId Airtable project record id
		 * @returns {Promise<Array<Object>>}
		 */
		async function loadStudies(projectId) {
			const url = `/api/studies?project=${encodeURIComponent(projectId)}`;
			const res = await fetch(url, { cache: "no-store" });
			const js = await res.json().catch(() => ({}));
			if (!res.ok || js?.ok !== true || !Array.isArray(js.studies)) {
				throw new Error(js?.error || `Studies fetch failed (${res.status})`);
			}
			return js.studies;
		}

		/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		 * Bootstrap
		 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
		(async function init() {
			try {
				const usp = new URLSearchParams(location.search);
				const pid = usp.get("pid") || "";
				const sid = usp.get("sid") || "";
				if (!pid || !sid) throw new Error("Missing pid or sid in URL");

				// Fetch both project and study for context
				const [projRes, studies] = await Promise.all([
					fetch(`/api/projects/${encodeURIComponent(pid)}`, { cache: "no-store" }),
					loadStudies(pid)
				]);
				const project = projRes.ok ? await projRes.json() : {};
				const study = studies.find(s => s.id === sid) || {};

				// Breadcrumbs
				$("#breadcrumb-project").href = `/pages/project-dashboard/?id=${encodeURIComponent(pid)}`;
				$("#breadcrumb-project").textContent = project?.name || "Project";
				$("#breadcrumb-study").href = `/pages/study/?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}`;
				$("#breadcrumb-study").textContent = pickTitle(study);

				// Header + subtitle
				$("#study-title").textContent = pickTitle(study);
				$("#back-to-study").href = `/pages/study/?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}`;

				// Context exposed for guides-page.js
				window.__guideCtx = { project, study };
			} catch (err) {
				console.error("[guides] init error:", err);
				alert("Could not load study or project context.");
			}
		})();
	</script>
</body>

</html>
