<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Discussion Guides ‚Äî Study</title>

	<link rel="stylesheet" href="/css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="/css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="/css/screen.css" media="screen" />
	<link rel="stylesheet" href="/css/guides.css" media="screen" />

	<script type="module" src="/components/layout.js"></script>
	<script type="module" src="/components/guides/guides-page.js" defer></script>
</head>

<body>
	<!-- Debug Console (iPad-friendly) -->
	<style>
		/* === DEBUG CONSOLE (iPad-friendly) ========================= */

		.debug-toggle {
			position: fixed;
			bottom: 20px;
			right: 20px;
			width: 56px;
			height: 56px;
			border-radius: 50%;
			background: #d4351c;
			color: white;
			border: none;
			font-size: 24px;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			z-index: 9998;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.debug-toggle:active {
			transform: scale(0.95);
		}

		.debug-console {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			height: 40vh;
			background: #1a1a1a;
			color: #0f0;
			font-family: 'Courier New', monospace;
			font-size: 12px;
			z-index: 9999;
			display: flex;
			flex-direction: column;
			box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5);
		}

		.debug-console[hidden] {
			display: none;
		}

		.debug-console__header {
			background: #0b0c0c;
			color: white;
			padding: 12px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			border-bottom: 1px solid #333;
		}

		.debug-console__header span {
			font-weight: bold;
		}

		.debug-console__btn {
			background: #d4351c;
			color: white;
			border: none;
			padding: 6px 12px;
			border-radius: 4px;
			margin-left: 8px;
			cursor: pointer;
			font-size: 12px;
		}

		.debug-console__btn:active {
			background: #b02d17;
		}

		.debug-console__output {
			flex: 1;
			overflow-y: auto;
			padding: 12px;
			-webkit-overflow-scrolling: touch;
		}

		.debug-log {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #0f0;
			background: rgba(0, 255, 0, 0.05);
		}

		.debug-error {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #d4351c;
			background: rgba(212, 53, 28, 0.1);
			color: #ff6b6b;
		}

		.debug-warn {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #ffdd00;
			background: rgba(255, 221, 0, 0.1);
			color: #ffdd00;
		}

		.debug-info {
			margin: 4px 0;
			padding: 4px 8px;
			border-left: 3px solid #1d70b8;
			background: rgba(29, 112, 184, 0.1);
			color: #5bc0de;
		}

		.debug-timestamp {
			color: #666;
			font-size: 10px;
			margin-right: 8px;
		}

		@media (min-width: 768px) {
			.debug-console {
				right: 0;
				left: auto;
				width: 400px;
				height: 60vh;
			}
		}
	</style>
	<script>
		/**
		 * @file guides-page-debug.js
		 * @summary iPad-friendly in-page debug console + network tap for /pages/study/guides/.
		 * - Captures console logs, errors, and unhandled rejections
		 * - Instruments window.fetch and XHR to log request/response details
		 * - Provides utility helpers to inspect responses when JSON parsing fails
		 */
		(function() {
			/* ====================== Ring buffer + UI ====================== */
			const logs = [];
			const maxLogs = 200;

			function escapeHtml(str) {
				const div = document.createElement('div');
				div.textContent = String(str);
				return div.innerHTML;
			}

			function addLog(type, args) {
				const timestamp = new Date().toLocaleTimeString();
				const message = Array.from(args).map(arg => {
					if (typeof arg === 'object') {
						try { return JSON.stringify(arg, null, 2); } catch { return String(arg); }
					}
					return String(arg);
				}).join(' ');

				logs.push({ type, timestamp, message });
				if (logs.length > maxLogs) logs.shift();

				const output = document.getElementById('debug-output');
				if (output) {
					const entry = document.createElement('div');
					entry.className = `debug-${type}`;
					entry.innerHTML = `<span class="debug-timestamp">${timestamp}</span>${escapeHtml(message)}`;
					output.appendChild(entry);
					output.scrollTop = output.scrollHeight;
				}
			}

			/* ====================== Console interception ====================== */
			const originalLog = console.log;
			const originalError = console.error;
			const originalWarn = console.warn;
			const originalInfo = console.info;

			console.log = function() { try { originalLog.apply(console, arguments); } finally { addLog('log', arguments); } };
			console.error = function() { try { originalError.apply(console, arguments); } finally { addLog('error', arguments); } };
			console.warn = function() { try { originalWarn.apply(console, arguments); } finally { addLog('warn', arguments); } };
			console.info = function() { try { originalInfo.apply(console, arguments); } finally { addLog('info', arguments); } };

			/* ====================== Global error taps ====================== */
			window.addEventListener('error', function(e) {
				addLog('error', [`üí• ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`]);
			});
			window.addEventListener('unhandledrejection', function(e) {
				addLog('error', [`‚ö†Ô∏è Unhandled Promise: ${e.reason}`]);
			});

			/* ====================== Helpers ====================== */
			async function getJsonOrText(res) {
				const text = await res.text().catch(() => '');
				try { return { json: JSON.parse(text), raw: text }; } catch { return { json: null, raw: text }; }
			}

			// Export current buffer as JSON (attach to window for convenience)
			function debugExport() {
				const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.download = `debug-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
				a.href = url;
				a.click();
				setTimeout(() => URL.revokeObjectURL(url), 1000);
			}
			window.debugExport = debugExport;

			/* ====================== fetch instrumentation ====================== */
			const _fetch = window.fetch.bind(window);
			window.fetch = async function(input, init) {
				const url = (typeof input === 'string') ? input : (input && input.url) || String(input);
				const method = (init && init.method) || (input && input.method) || 'GET';
				const started = performance.now();

				console.info(`[net] ${method} ${url}`);
				try {
					const res = await _fetch(input, init);
					const ms = Math.round(performance.now() - started);
					let info = { status: res.status, ok: res.ok, ms };

					// Attempt to parse JSON (non-destructively) for visibility
					try {
						const clone = res.clone();
						const { json, raw } = await getJsonOrText(clone);
						if (json) {
							console.info(`[net] ‚Üê ${method} ${url} ${res.status} (${ms}ms)`, json);
						} else {
							const snippet = raw && raw.slice ? raw.slice(0, 400) : raw;
							console.info(`[net] ‚Üê ${method} ${url} ${res.status} (${ms}ms) [text]`, snippet);
						}
					} catch {
						console.warn(`[net] ‚Üê ${method} ${url} ${res.status} (${ms}ms) [unreadable body]`, info);
					}
					return res;
				} catch (err) {
					const ms = Math.round(performance.now() - started);
					console.error(`[net] ‚úñ ${method} ${url} failed after ${ms}ms`, err);
					throw err;
				}
			};

			/* ====================== XHR instrumentation (legacy) ====================== */
			(function() {
				const XHR = window.XMLHttpRequest;
				if (!XHR) return;
				const open = XHR.prototype.open;
				const send = XHR.prototype.send;

				XHR.prototype.open = function(method, url) {
					this.__debug = { method, url, start: 0 };
					return open.apply(this, arguments);
				};
				XHR.prototype.send = function(body) {
					if (this.__debug) this.__debug.start = performance.now();
					this.addEventListener('loadend', () => {
						const d = this.__debug || {};
						const ms = d.start ? Math.round(performance.now() - d.start) : 0;
						const status = this.status;
						let snippet = '';
						try { snippet = (this.responseText || '').slice(0, 400); } catch {}
						const label = status ? `[xhr] ‚Üê ${d.method} ${d.url} ${status} (${ms}ms)` : `[xhr] ‚Üê ${d.method} ${d.url} (${ms}ms)`;
						if (status >= 200 && status < 300) console.info(label, snippet);
						else console.warn(label, snippet);
					});
					return send.apply(this, arguments);
				};
			})();

			/* ====================== UI wiring ====================== */
			window.addEventListener('DOMContentLoaded', function() {
				const toggle = document.getElementById('debug-toggle');
				const debugConsole = document.getElementById('debug-console');
				const closeBtn = document.getElementById('debug-close');
				const clearBtn = document.getElementById('debug-clear');
				const exportBtn = document.getElementById('debug-export');

				if (toggle && debugConsole) toggle.addEventListener('click', () => { debugConsole.hidden = !debugConsole.hidden; });
				if (closeBtn && debugConsole) closeBtn.addEventListener('click', () => { debugConsole.hidden = true; });
				if (clearBtn) clearBtn.addEventListener('click', () => {
					logs.length = 0;
					const output = document.getElementById('debug-output');
					if (output) output.innerHTML = '';
				});
				if (exportBtn) exportBtn.addEventListener('click', () => debugExport());

				console.log('üêõ Debug console initialized');
			});
		})();
	</script>
	<div id="debug-console" class="debug-console" hidden>
		<div class="debug-console__header">
			<span>üêõ Debug Console</span>
			<button id="debug-clear" class="debug-console__btn">Clear</button>
			<button id="debug-close" class="debug-console__btn">Close</button>
		</div>
		<div id="debug-output" class="debug-console__output"></div>
	</div>
	<button id="debug-toggle" class="debug-toggle">üêõ</button>

	<!-- Rest of your page continues here -->
	<div class="app-layout">
		<!-- ... existing content ... -->
	</div>
	<x-include src="/partials/header.html" vars='{
		"active":"Projects",
		"subtitle":"Study ‚Äî Discussion Guides"
	}'></x-include>

	<main id="main" class="container govuk-body" role="main">
		<!-- Breadcrumb -->
		<nav class="breadcrumbs" aria-label="Breadcrumb">
			<ol>
				<li><a href="/pages/projects/">Projects</a></li>
				<li><a id="breadcrumb-project" href="#">Project</a></li>
				<li><a id="breadcrumb-study" href="#">Study</a></li>
				<li aria-current="page">Guides</li>
			</ol>
		</nav>

		<!-- Page header (titles only) -->
		<header class="page-header">
			<div class="page-header__titles">
				<h2 id="guides-list-title" class="govuk-heading-m">Guides for this study</h2>
				<p id="study-subtitle" class="muted">Study: <span id="study-title" data-bind="study.title">‚Äî</span></p>
			</div>

			<!-- List toolbar row (baseline-aligned with the h2) -->
			<div class="guides-header" role="toolbar" aria-label="Discussion guide actions">
				<div class="toolbar">
					<button id="btn-new" class="btn">Ôºã New guide</button>
					<button id="btn-import" class="btn btn--secondary">‚§í Import .md</button>
					<a id="back-to-study" class="btn btn--secondary" href="#">‚Üê Back to Study</a>
				</div>
			</div>
		</header>

		<!-- Guides table -->
		<section id="guides-list-section" aria-labelledby="guides-list-title">
			<div class="table-wrap">
				<table class="table" role="table">
					<thead>
						<tr>
							<th scope="col">Title</th>
							<th scope="col">Status</th>
							<th scope="col">Version</th>
							<th scope="col">Updated</th>
							<th scope="col">Owner</th>
							<th scope="col"><span class="sr-only">Actions</span></th>
						</tr>
					</thead>
					<tbody id="guides-tbody">
						<tr>
							<td colspan="6" class="muted">Loading‚Ä¶</td>
						</tr>
					</tbody>
				</table>
			</div>
		</section>

		<hr class="divider" />

		<!-- Editor section -->
		<section id="editor-section" class="editor is-hidden" aria-labelledby="editor-title">
			<div class="editor__header">
				<h2 id="editor-title" class="govuk-heading-m">Guide editor</h2>
			</div>

			<!-- Editor toolbar row (left: Tag/Pattern/Variables; right: Save/Publish/Export/Title) -->
			<div class="editor__toolbar" role="toolbar" aria-label="Editor actions">
				<div class="toolbar-group toolbar-group--left">
					<button id="btn-insert-tag" class="btn btn--secondary">Tag</button>
					<button id="btn-insert-pattern" class="btn btn--secondary">Pattern</button>
					<button id="btn-variables" class="btn btn--secondary">Variables</button>
				</div>

				<div class="toolbar-group toolbar-group--right">
					<button id="btn-save" class="btn">üíæ Save</button>
					<button id="btn-publish" class="btn btn--primary">‚¨Ü Publish</button>
					<div class="menu">
						<button id="btn-export" class="btn btn--secondary" aria-haspopup="true" aria-expanded="false">Export</button>
						<ul id="export-menu" class="menu__list" role="menu" aria-label="Export as">
							<li role="menuitem"><button data-export="md">Markdown (.md)</button></li>
							<li role="menuitem"><button data-export="html">HTML (.html)</button></li>
							<li role="menuitem"><button data-export="pdf">PDF (.pdf)</button></li>
							<li role="menuitem"><button data-export="docx">Docx (.docx)</button></li>
						</ul>
					</div>
					<label for="guide-title" class="label-inline">Guide title</label>
					<input id="guide-title" type="text" value="New guide" placeholder="Guide title" />
				</div>
			</div>

			<!-- Source + preview split -->
			<div class="editor__split" aria-label="Source and preview">
				<section class="pane pane--source" aria-labelledby="source-title">
					<h3 id="source-title" class="govuk-heading-s">Source (Markdown + Mustache)</h3>

					<!-- Code editor with syntax highlighting -->
					<div class="code-editor">
						<div class="code-editor__highlight" id="guide-source-highlight" aria-hidden="true">
							<pre class="language-markdown"><code id="guide-source-code"></code></pre>
						</div>
						<textarea id="guide-source" class="code-editor__textarea" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" aria-describedby="lint-output"></textarea>
					</div>

					<div id="lint-output" class="lint" role="status" aria-live="polite"></div>
				</section>

				<section class="pane pane--preview" aria-labelledby="preview-title">
					<h3 id="preview-title" class="govuk-heading-s">Live preview</h3>
					<article id="guide-preview" class="preview" role="document" tabindex="0">
						<p class="muted">Start typing to see a preview‚Ä¶</p>
					</article>
				</section>
			</div>

			<!-- Drawers (must remain after editor__split) -->
			<aside id="drawer-patterns" class="drawer" aria-labelledby="drawer-patterns-title" hidden>
				<h3 id="drawer-patterns-title" class="govuk-heading-s">Pattern library</h3>
				<input id="pattern-search" class="input" placeholder="Search patterns" />
				<ul id="pattern-list" class="list-plain"></ul>
				<button id="drawer-patterns-close" class="link-like">Close</button>
			</aside>

			<aside id="drawer-variables" class="drawer" aria-labelledby="drawer-variables-title" hidden>
				<h3 id="drawer-variables-title" class="govuk-heading-s">Variables</h3>

				<div class="panel muted" id="variables-intro" aria-describedby="variables-help">
					<p id="variables-help">
						Variables personalise your guide using Mustache tags like <code>{{participant.name}}</code>.
						This editor stores variables as <strong>JSON</strong> in Airtable (‚ÄúVariables (JSON)‚Äù).
					</p>
					<ul>
						<li><strong>Create</strong> with ‚Äú+ Add‚Äù. Use short, semantic keys (e.g. <code>version</code> or <code>session.date</code>).</li>
						<li><strong>Edit</strong> values inline. Accepts text, numbers, booleans, or JSON.</li>
						<li><strong>Delete</strong> using the ‚úñ on a row (with confirmation).</li>
						<li><strong>Save variables</strong> posts JSON back to Airtable without changing your Markdown body.</li>
					</ul>
				</div>

				<form id="variables-form" class="form-grid">
					<div id="variable-manager-container"></div>

					<div class="actions-row">
						<button id="btn-save-vars" class="btn" type="button">üíæ Save variables</button>
						<button id="btn-reset-vars" class="btn btn--secondary" type="button">‚Ü∫ Discard changes</button>
						<button id="drawer-variables-close" class="link-like" type="button">Close</button>
					</div>

					<p id="variables-status" class="muted" aria-live="polite"></p>
				</form>
			</aside>
		</section>

		<div id="sr-live" class="sr-only" aria-live="polite"></div>

		<section id="debug-panel" hidden class="debug-panel">
			<h3>Debug output</h3>
			<pre id="debug-output" class="debug-output">Debugging disabled.</pre>
			<style>
				.debug-panel {
					margin-top: 24px;
					padding: 12px;
					background: #f3f2f1;
					border: 1px solid #b1b4b6;
					overflow-x: auto;
					white-space: pre-wrap;
					font-family: monospace;
				}
			</style>
		</section>
	</main>

	<x-include src="/partials/footer.html"></x-include>

	<script type="module">
		/**
		 * @file /pages/study/guides/index.html
		 * @module GuidesPage
		 * @summary Fetches project + study data, ensuring a valid title is always shown.
		 * @description
		 * - Title uses `study.title || study.Title || Method ‚Äî YYYY-MM-DD`.
		 * - Binds study name into breadcrumb and header subtitle.
		 * - Routes ‚ÄúBack to Study‚Äù to `/pages/study/?pid=‚Ä¶&sid=‚Ä¶`.
		 * - Exposes context for /components/guides/guides-page.js.
		 */

		const $ = (s, r = document) => r.querySelector(s);

		/** Compute fallback ‚ÄúMethod ‚Äî YYYY-MM-DD‚Äù for studies missing a title. */
		function fallbackTitle(s = {}) {
			const method = (s.method || "Study").trim();
			const d = s.createdAt ? new Date(s.createdAt) : new Date();
			const yyyy = d.getUTCFullYear();
			const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
			const dd = String(d.getUTCDate()).padStart(2, "0");
			return `${method} ‚Äî ${yyyy}-${mm}-${dd}`;
		}

		/** Pick the best available title. */
		function pickTitle(s = {}) {
			return (s.title || s.Title || "").trim() || fallbackTitle(s);
		}

		/** Load studies for a project from the Worker API. */
		async function loadStudies(projectId) {
			const url = `/api/studies?project=${encodeURIComponent(projectId)}`;
			const res = await fetch(url, { cache: "no-store" });
			const js = await res.json().catch(() => ({}));
			if (!res.ok || js?.ok !== true || !Array.isArray(js.studies)) {
				throw new Error(js?.error || `Studies fetch failed (${res.status})`);
			}
			return js.studies;
		}

		/* ‚îÄ‚îÄ Bootstrap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
		(async function init() {
			try {
				const usp = new URLSearchParams(location.search);
				const pid = usp.get("pid") || "";
				const sid = usp.get("sid") || "";
				if (!pid || !sid) throw new Error("Missing pid or sid in URL");

				// Fetch both project and study for context
				const [projRes, studies] = await Promise.all([
					fetch(`/api/projects/${encodeURIComponent(pid)}`, { cache: "no-store" }),
					loadStudies(pid)
				]);
				const project = projRes.ok ? await projRes.json() : {};
				const study = studies.find(s => s.id === sid) || {};

				// Breadcrumbs
				$("#breadcrumb-project").href = `/pages/project-dashboard/?id=${encodeURIComponent(pid)}`;
				$("#breadcrumb-project").textContent = project?.name || "Project";
				$("#breadcrumb-study").href = `/pages/study/?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}`;
				$("#breadcrumb-study").textContent = pickTitle(study);

				// Header + subtitle
				$("#study-title").textContent = pickTitle(study);
				$("#back-to-study").href = `/pages/study/?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}`;

				// Context exposed for guides-page.js
				window.__guideCtx = { project, study };
			} catch (err) {
				console.error("[guides] init error:", err);
				alert("Could not load study or project context.");
			}
		})();
	</script>
</body>

</html>
