<!doctype html>
<html lang="en-GB" prefix="
  dcterms: http://purl.org/dc/terms/
  schema:  https://schema.org/
">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="sda-auto" content="true" />
	<meta property="dcterms:creator" content="Home Office Biometrics" />
	<title property="dcterms:title">Reflexive Journal &amp; Analysis &mdash; ResearchOps</title>

	<link rel="stylesheet" href="/css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="/css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="/css/screen.css">
	<link rel="stylesheet" href="/css/tabs.css" />
	<link rel="stylesheet" href="/css/journal.css">

	<!-- Components/layout first -->
	<script type="module" src="/components/layout.js" defer></script>
</head>

<body typeof="schema:WebPage">
	<!-- Global header -->
	<x-include src="/partials/header.html" vars='{
		"active":"Projects",
		"subtitle":"Research Analysis"
	}'></x-include>

	<nav class="breadcrumbs" aria-label="Breadcrumb">
		<a href="/pages/projects/">Projects</a> &rarr;
		<a href="#" id="project-link">Project Dashboard</a> &rarr;
		<span>Journal &amp; Analysis</span>
	</nav>

	<header role="banner" class="journal-header">
		<div>
			<h2 property="dcterms:title">Reflexive Journal &amp; Analysis</h2>
			<p class="hint">Document and analyze your research journey</p>
		</div>
	</header>

	<main id="content" role="main">
		<!-- GOV.UK Tabs Component -->
		<div class="govuk-tabs" data-module="govuk-tabs" id="journals-tabs">
			<h2 class="govuk-tabs__title">Contents</h2>

			<ul class="govuk-tabs__list">
				<li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
					<a class="govuk-tabs__tab" href="#journal-entries">Journal entries</a>
				</li>
				<li class="govuk-tabs__list-item">
					<a class="govuk-tabs__tab" href="#codes">Codes</a>
				</li>
				<li class="govuk-tabs__list-item">
					<a class="govuk-tabs__tab" href="#memos">Memos</a>
				</li>
				<li class="govuk-tabs__list-item">
					<a class="govuk-tabs__tab" href="#analysis">Analysis</a>
				</li>
			</ul>

			<!-- Panel: Journal entries -->
			<div class="govuk-tabs__panel" id="journal-entries">
				<h3 class="govuk-heading-m">Journal entries</h3>

				<div id="journal-entries-panel">
					<button type="button" class="govuk-button" data-module="govuk-button" id="new-entry-btn">
						Add journal entry
					</button>

					<!-- Entry form (initially hidden) -->
					<div class="govuk-form-group" id="entry-form" hidden>
						<form id="add-entry-form" novalidate>
							<div class="govuk-form-group">
								<label class="govuk-label govuk-label--s" for="entry-category">Category</label>
								<select class="govuk-select" id="entry-category" name="category" required>
									<option value="perceptions">Evolving perceptions</option>
									<option value="procedures">Day-to-day procedures</option>
									<option value="decisions">Methodological decision points</option>
									<option value="introspections">Personal introspections</option>
								</select>
							</div>

							<div class="govuk-form-group">
								<label class="govuk-label govuk-label--s" for="entry-content">Entry</label>
								<div id="content-hint" class="govuk-hint">Write freely; this is a private space for research reflection</div>
								<textarea class="govuk-textarea" id="entry-content" name="content" rows="8" required aria-describedby="content-hint"></textarea>
							</div>

							<div class="govuk-form-group">
								<label class="govuk-label govuk-label--s" for="entry-tags">Tags (optional)</label>
								<div id="tags-hint" class="govuk-hint">Comma-separated keywords for easier retrieval</div>
								<input class="govuk-input" type="text" id="entry-tags" name="tags" aria-describedby="tags-hint" />
							</div>

							<div class="govuk-button-group">
								<button type="submit" class="govuk-button" data-module="govuk-button">Save entry</button>
								<button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button" id="cancel-form-btn">Cancel</button>
							</div>
						</form>
					</div>

					<!-- Filter chips (visually distinct from tabs) -->
					<div class="journal-filters" role="group" aria-label="Filter entries by category">
						<h4 class="govuk-heading-s">Filter by category</h4>
						<div class="filter-chips">
							<button type="button" class="filter-chip filter-chip--active" data-filter="all">All entries</button>
							<button type="button" class="filter-chip" data-filter="perceptions">Perceptions</button>
							<button type="button" class="filter-chip" data-filter="procedures">Procedures</button>
							<button type="button" class="filter-chip" data-filter="decisions">Decisions</button>
							<button type="button" class="filter-chip" data-filter="introspections">Introspections</button>
						</div>
					</div>

					<!-- Journal entries list -->
					<div id="entries-container" class="govuk-!-margin-top-6">
						<!-- cards render here -->
						<div class="empty-state" id="empty-journal" hidden>
							<p class="govuk-body">No entries match the current filter.</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Panel: Codes -->
			<div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="codes">
				<h3 class="govuk-heading-m">Codebook management</h3>
				<div id="codes-panel">
					<button type="button" class="govuk-button" data-module="govuk-button" id="new-code-btn">Add code</button>
					<div id="codes-container"></div>
				</div>
			</div>

			<!-- Panel: Memos -->
			<div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="memos">
				<h3 class="govuk-heading-m">Research memos</h3>
				<div id="memos-panel">
					<button type="button" class="govuk-button" data-module="govuk-button" id="new-memo-btn">Add memo</button>

					<div class="memo-filters govuk-!-margin-top-4">
						<h4 class="govuk-heading-s">Filter by memo type</h4>
						<div class="filter-chips">
							<button type="button" class="filter-chip filter-chip--active" data-memo-filter="all">All</button>
							<button type="button" class="filter-chip" data-memo-filter="analytical">Analytical</button>
							<button type="button" class="filter-chip" data-memo-filter="methodological">Methodological</button>
							<button type="button" class="filter-chip" data-memo-filter="theoretical">Theoretical</button>
							<button type="button" class="filter-chip" data-memo-filter="reflexive">Reflexive</button>
						</div>
					</div>

					<div id="memos-container" class="govuk-!-margin-top-6"></div>
				</div>
			</div>

			<!-- Panel: Analysis -->
			<div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="analysis">
				<h3 class="govuk-heading-m">Analysis tools</h3>
				<div id="analysis-panel">
					<div class="govuk-button-group">
						<button type="button" class="govuk-button" data-analysis="timeline">Timeline view</button>
						<button type="button" class="govuk-button govuk-button--secondary" data-analysis="co-occurrence">Code co-occurrence</button>
						<button type="button" class="govuk-button govuk-button--secondary" data-analysis="retrieval">Code retrieval</button>
						<button type="button" class="govuk-button govuk-button--secondary" data-analysis="export">Export analysis</button>
					</div>

					<div id="analysis-container" class="govuk-!-margin-top-6" data-role="analysis-container">
						<section id="analysis-timeline" class="govuk-!-margin-bottom-6" aria-live="polite"></section>
						<section id="analysis-cooccurrence" class="govuk-!-margin-bottom-6" aria-live="polite"></section>

						<section id="analysis-retrieval" class="govuk-!-margin-bottom-6" aria-live="polite">
							<form id="retrieval-form" class="govuk-form-group" novalidate>
								<label class="govuk-label" for="retrieval-q">Search term</label>
								<input class="govuk-input" id="retrieval-q" name="q" type="text" spellcheck="true" autocomplete="off" />
								<div class="govuk-hint">Searches code names and journal text.</div>
								<button class="govuk-button govuk-!-margin-top-2" type="submit" data-module="govuk-button">Run search</button>
							</form>
							<div id="retrieval-results" class="govuk-!-margin-top-3"></div>
						</section>

						<details class="govuk-details govuk-!-margin-top-4" data-module="govuk-details" id="json-viewer">
							<summary class="govuk-details__summary">
								<span class="govuk-details__summary-text">View raw JSON</span>
							</summary>
							<div class="govuk-details__text">
								<div class="govuk-button-group">
									<button type="button" class="govuk-button govuk-button--secondary" id="json-copy">Copy JSON</button>
									<button type="button" class="govuk-button govuk-button--secondary" id="json-download">Download JSON</button>
								</div>
								<pre class="app-codeblock" tabindex="0" aria-label="Raw JSON"><code id="json-code"></code></pre>
							</div>
						</details>
					</div>
				</div>
			</div>
		</div>
	</main>

	<!-- Coding panel (initially hidden, overlays content) -->
	<aside id="coding-panel" class="coding-panel" hidden aria-label="Apply codes">
		<div class="panel-header">
			<h3>Apply Codes</h3>
			<button type="button" class="close-panel" aria-label="Close coding panel">âœ•</button>
		</div>

		<div class="selected-text-preview">
			<h4>Selected text:</h4>
			<blockquote id="selected-text-display"></blockquote>
		</div>

		<div class="code-search">
			<label for="code-search-input" class="visually-hidden">Search codes</label>
			<input type="search" id="code-search-input" placeholder="Search codes&hellip;">
		</div>

		<div class="codebook-tree" id="coding-codebook" role="tree">
			<!-- Code list for selection -->
		</div>

		<div class="coding-confidence">
			<fieldset>
				<legend>Confidence level</legend>

				<label>
					<input type="radio" name="confidence" value="low" />
					Low
				</label>

				<label>
					<input type="radio" name="confidence" value="medium" checked />
					Medium
				</label>

				<label>
					<input type="radio" name="confidence" value="high" />
					High
				</label>
			</fieldset>
		</div>

		<div class="coding-memo">
			<label for="coding-memo-input">Coding memo (optional)</label>

			<textarea id="coding-memo-input" rows="3" placeholder="Why this code? Any reflections?"></textarea>
		</div>

		<div class="panel-actions">
			<button type="button" class="btn" id="apply-code-btn">Apply Code</button>

			<button type="button" class="btn-secondary" id="cancel-coding-btn">Cancel</button>
		</div>
	</aside>

	<x-include src="/partials/footer.html"></x-include>

	<script type="module" src="/components/journal-tabs.js" defer></script>
	<script type="module" src="/components/journal-excerpts.js" defer></script>
	<script type="module" src="/js/caqdas-interface.js" defer></script>
	<!-- GOV.UK Frontend JS (enhances tabs + stores #hash for back/forward nav) -->
	<script type="module" src="/js/tabs.js" defer></script>
	<script>
		(function() {
			// When everything (including modules) has attached, activate the current tab once more.
			function activateCurrent() {
				var hash = (location.hash || '#journal-entries');
				var id = hash.slice(1);
				// Make sure the target panel is not hidden by any leftover attributes/classes.
				var panel = document.getElementById(id);
				if (panel) {
					panel.classList.remove('govuk-tabs__panel--hidden');
					panel.removeAttribute('hidden');
					// Fire a synthetic activation so late listeners (entries/codes/memos) can populate.
					panel.dispatchEvent(new CustomEvent('tab:shown', { bubbles: true, detail: { id: id, container: panel.closest('.govuk-tabs') } }));
				}
			}

			// Support ?tab=codes as an alias for #codes
			function applyQueryTab() {
				var params = new URLSearchParams(location.search);
				var qtab = params.get('tab');
				if (!qtab) return;
				// Prefer aria-controls (set by tabs.js), fall back to href
				var link = document.querySelector('.govuk-tabs__tab[aria-controls="' + qtab + '"]') ||
					document.querySelector('.govuk-tabs__tab[href="#' + qtab + '"]');
				if (!link) return;
				if (location.hash !== '#' + qtab) history.replaceState(null, '', location.pathname + location.search + '#' + qtab);
				// Click to let tabs.js select properly
				link.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
			}

			// Run after DOM is ready so tabs.js has initialised, then re-emit on next tick.
			document.addEventListener('DOMContentLoaded', function() {
				applyQueryTab();
				setTimeout(activateCurrent, 0);
			});

			// If other modules load later and you still need a belt-and-braces kick, re-emit on window load.
			window.addEventListener('load', function() {
				setTimeout(activateCurrent, 0);
			});
		})();
	</script>
</body>

</html>
