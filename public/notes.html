<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Notes — ResearchOps</title>
	
	<link rel="stylesheet" href="./css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="./css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="./css/screen.css" media="screen" />
	<script type="module" src="./components/layout.js"></script>
</head>

<body>
	<x-include
		src="./partials/header.html"
		vars='{"active":"Notes","subtitle":"Notes"}'>	
	</x-include>

	<div class="card">
		<h2 class="govuk-heading-m">Select a session</h2>
		<select id="session"></select>
	</div>

	<div class="card">
		<h2 class="govuk-heading-m">Add a note</h2>
		<textarea id="text" placeholder="Avoid PII; describe behaviour, quotes, observations"></textarea>
		<input id="tags" class="govuk-input" placeholder="Tags (comma-separated, e.g., Usability, Navigation)" />
		<button id="save" class="govuk-button">Save note</button>
		<div id="status" class="govuk-hint"></div>
	</div>

	<div class="card">
		<h2 class="govuk-heading-m">Notes in this session</h2>
		<div id="notes"></div>
	</div>
	
	<x-include src="./partials/footer.html"></x-include>

	<script type="module">
		import { ResearchOpsSDK } from "../src/sdk/researchops_sdk_v1.0.0.js";
		import { getCtx, formatDate } from "./scripts/shared.js";
		const sdk = ResearchOpsSDK.createSDK({ ...getCtx() });

		async function populateSessions() {
			const list = await sdk.search({ type: "ResearchSession" });
			const sel = document.getElementById('session');
			sel.innerHTML = "";
			list.forEach(s => {
				const opt = document.createElement('option');
				opt.value = s.id;
				opt.textContent = `${s.name || "(Untitled)"} — ${formatDate(s["schema:startDate"]||s.created)}`;
				sel.appendChild(opt);
			});
			return sel.value || null;
		}

		async function loadNotes(sessionId) {
			const allNotes = await sdk.search({ type: "Note" });
			const allTags = await sdk.search({ type: "Tag" }); // fetch once

			const div = document.getElementById('notes');
			const filtered = allNotes.filter(n => n.hasTarget === sessionId);

			div.innerHTML = filtered.map(n => {
				const tags = allTags.filter(t => t.hasTarget === n.id);
				const tagsHtml = tags.map(t => `<span class="tag">${t.name}</span>`).join("");
				return `<div class="item">
      <strong>${formatDate(n.created)}</strong>
      <div class="govuk-body">${n.hasBody}</div>
      <div>${tagsHtml || '<span class="govuk-hint">No tags</span>'}</div>
    </div>`;
			}).join("") || '<div class="govuk-hint">No notes yet.</div>';
		}

		document.getElementById('session').onchange = async e => {
			await loadNotes(e.target.value);
		};
		document.getElementById('save').onclick = async () => {
			const sid = document.getElementById('session').value;
			if (!sid) return alert("Create/select a session first.");
			const text = document.getElementById('text').value.trim();
			if (!text) return alert("Enter a note.");
			const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(Boolean);
			const n = await sdk.addNote(sid, { text, tags });
			document.getElementById('status').textContent = `Saved note ${n.id}`;
			await loadNotes(sid);
			document.getElementById('text').value = "";
			document.getElementById('tags').value = "";
		};

		const first = await populateSessions();
		if (first) await loadNotes(first);
	</script>
</body>

</html>
