<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study — ResearchOps</title>

  <link rel="stylesheet" href="./css/govuk/govuk-typography.css" media="screen" />
  <link rel="stylesheet" href="./css/govuk/govuk-colours.css" media="screen" />
  <link rel="stylesheet" href="./css/screen.css" media="screen" />
  <script type="module" src="./components/layout.js"></script>
</head>

<body>
  <x-include src="./partials/header.html" vars='{
    "active":"Projects",
    "subtitle":"Study"
  }'></x-include>

  <main class="govuk-body" role="main">
    <div class="actions-bar">
      <a id="back-to-project" href="./projects.html" class="btn btn--secondary">← Back to Project</a>
      <a id="edit-study" href="#" class="btn">✎ Edit Study</a>
    </div>

    <!-- Hero -->
    <div class="dashboard-hero">
      <p id="study-eyebrow" class="project-org"></p>
      <h1 id="study-title" class="govuk-heading-l">Study</h1>

      <!-- Description lives under the title -->
      <div id="desc-view-wrap">
        <div id="description" class="govuk-body">—</div>
        <div class="actions-bar" style="margin-top:8px;">
          <button id="btn-edit-desc" type="button" class="btn btn--outline">✎ Edit description</button>
        </div>
      </div>

      <!-- Inline editor (hidden by default) -->
      <form id="desc-editor" class="panel" hidden>
        <label class="govuk-label" for="desc-input">Description (Markdown)</label>
        <textarea id="desc-input" class="govuk-input" rows="8" spellcheck="true" autocomplete="off"></textarea>
        <div class="actions-bar" style="gap:8px;">
          <button class="btn" type="submit">Save</button>
          <button class="btn btn--secondary" id="desc-cancel" type="button">Cancel</button>
        </div>

        <!-- Allowed Markdown cheat sheet -->
        <details class="note" style="margin-top:8px;">
          <summary>Markdown cheat sheet (allowed)</summary>
          <div>
            <p>You can use a safe subset of Markdown:</p>
            <ul>
              <li>Headings: <code>#</code> … <code>######</code></li>
              <li>Bold / italic: <code>**bold**</code>, <code>*italic*</code></li>
              <li>Links: <code>[text](https://…)</code></li>
              <li>Lists:
                <ul>
                  <li>Unordered: lines starting with <code>-</code>, <code>*</code> or <code>+</code></li>
                  <li>Ordered: <code>1. item</code></li>
                </ul>
              </li>
              <li>Inline code: <code>`code`</code></li>
              <li>Code block: triple backticks <code>```</code></li>
              <li>Paragraphs: blank line between blocks</li>
            </ul>
          </div>
        </details>
      </form>
    </div>

    <!-- Key info -->
    <section class="kv">
      <ul class="kv__list">
        <li><span class="kv__term">Method</span>&nbsp;<span class="kv__desc" id="kv-method">–</span></li>
        <li><span class="kv__term">Status</span>&nbsp;<span class="kv__desc" id="kv-status">–</span></li>
        <li><span class="kv__term">Study ID</span>&nbsp;<span class="kv__desc" id="kv-studyid">–</span></li>
      </ul>
    </section>

    <!-- Materials hubs (placeholders) -->
    <nav class="board" aria-label="Study setup">
      <a href="#" class="board__item" aria-disabled="true">Produce consent forms</a>
      <a href="#" class="board__item" aria-disabled="true">Manage consent</a>
      <a href="#" class="board__item" aria-disabled="true">Schedule participants</a>
      <a href="#" class="board__item" aria-disabled="true">Discussion guides</a>
      <a href="#" class="board__item" aria-disabled="true">Note takers &amp; observers</a>
      <a href="#" class="board__item" aria-disabled="true">Begin a session</a>
    </nav>

    <!-- Overview kept for future content -->
    <section class="section">
      <header class="section__header">
        <h2 class="section__title govuk-heading-m">Overview</h2>
      </header>
      <div class="section__body">
        <div class="panel">
          <p class="govuk-body">Set up your study materials and workflows here.</p>
        </div>
      </div>
    </section>
  </main>

  <x-include src="./partials/footer.html" vars='{"org":"Home Office Biometrics","build":"ResearchOps v1.0.0 (demo)"}'></x-include>

  <script type="module">
    /**
     * @file study.bootstrap.js (inline)
     * @summary Loads one study (by pid+sid), renders Markdown description under the title,
     * and allows editing with Markdown that PATCHes back to Airtable (via the Worker).
     */

    import { mdToAirtableRich } from "./js/richtext.js";

    /* ========== tiny helpers ========== */
    const $ = (sel, root = document) => root.querySelector(sel);
    const setText = (sel, value, fallback = "—") => {
      const el = $(sel);
      if (el) el.textContent = (value ?? "").toString().trim() || fallback;
    };

    /* ========== sanitise + markdown (minimal, safe subset) ========== */

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    /**
     * Very small, safe Markdown → HTML (headings, bold/italic, code, links, lists, paragraphs).
     * Intentionally conservative to avoid XSS; good enough for Airtable Rich Text parity.
     */
    function mdToHtml(md) {
      let src = String(md ?? "");

      // normalise newlines
      src = src.replace(/\r\n?/g, "\n");

      // code blocks (```lang?\n...\n```)
      src = src.replace(/```([\s\S]*?)```/g, (m, code) => {
        return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
      });

      // inline code
      src = src.replace(/`([^`]+?)`/g, (m, code) => `<code>${escapeHtml(code)}</code>`);

      // headings ###### to #
      src = src.replace(/^(#{1,6})[ \t]+(.+)$/gm, (m, hashes, text) => {
        const lvl = hashes.length;
        return `<h${lvl}>${escapeHtml(text.trim())}</h${lvl}>`;
      });

      // bold + italic (simple)
      src = src.replace(/\*\*([^*]+?)\*\*/g, "<strong>$1</strong>");
      src = src.replace(/\*([^*]+?)\*/g, "<em>$1</em>");

      // links: [text](url) — url escaped, text preserved (already escaped by earlier steps if needed)
      src = src.replace(/\[([^\]]+?)\]\((https?:\/\/[^\s)]+)\)/g, (m, text, url) => {
        const safeUrl = escapeHtml(url);
        return `<a class="govuk-link" href="${safeUrl}" rel="noopener noreferrer" target="_blank">${escapeHtml(text)}</a>`;
      });

      // lists (very small parser): handle groups of lines starting with -, +, *, or 1.
      src = src.replace(
        /(^|\n)(?:([ \t]*)([-*+])\s+.+(?:\n\2[-*+]\s+.+)*)/g,
        (m) => {
          const items = m.trim().split(/\n/).map(line => line.replace(/^[ \t]*[-*+]\s+/, "").trim());
          return `\n<ul>${items.map(i => `<li>${i}</li>`).join("")}</ul>`;
        }
      );

      src = src.replace(
        /(^|\n)(?:([ \t]*)(\d+)\.\s+.+(?:\n\2\d+\.\s+.+)*)/g,
        (m) => {
          const items = m.trim().split(/\n/).map(line => line.replace(/^[ \t]*\d+\.\s+/, "").trim());
          return `\n<ol>${items.map(i => `<li>${i}</li>`).join("")}</ol>`;
        }
      );

      // paragraphs: wrap leftover text blocks separated by blank lines
      const blocks = src
        .split(/\n{2,}/)
        .map(b => b.trim())
        .filter(Boolean)
        .map(b => {
          // already block-level? (starts with <h, <p, <ul, <ol, <pre)
          if (/^<(h\d|ul|ol|pre)/.test(b)) return b;
          return `<p>${b.replace(/\n/g, "<br>")}</p>`;
        });

      return blocks.join("\n");
    }

    function setMarkdown(selector, markdown) {
      const el = $(selector);
      if (!el) return;
      const html = mdToHtml(markdown);
      el.innerHTML = html;
    }

    /* ========== data ========== */

    /**
     * GET /api/studies?project=<aid>
     * @param {string} projectId
     * @returns {Promise<Array<{id:string, studyId?:string, method:string, status?:string, description?:string}>>}
     */
    async function loadStudies(projectId) {
      const res = await fetch(`/api/studies?project=${encodeURIComponent(projectId)}`, { cache: "no-store" });
      const js = await res.json().catch(() => ({}));
      if (!res.ok || !js?.ok) throw new Error(js?.error || `Studies fetch failed (${res.status})`);
      return js.studies || [];
    }

    /**
     * PATCH /api/studies/:id
     * Only sends fields that need updating. Here we update Description (as Markdown for Airtable Rich Text).
     * @param {string} studyId
     * @param {string} markdown
     * @returns {Promise<boolean>}
     */
    async function patchStudyDescription(studyId, markdown) {
      // Normalise Markdown before send (keeps preview == stored and consistent everywhere)
      const md = mdToAirtableRich(markdown);
      const res = await fetch(`/api/studies/${encodeURIComponent(studyId)}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ description: md })
      });
      const js = await res.json().catch(() => ({}));
      if (!res.ok || !js?.ok) throw new Error(js?.error || `PATCH failed (${res.status})`);
      return true;
      }

    /* ========== bootstrap ========== */

    (async function bootstrap() {
      try {
        const usp = new URLSearchParams(location.search);
        const pid = usp.get("pid") || "";
        const sid = usp.get("sid") || "";
        if (!pid || !sid) throw new Error("Missing pid or sid");

        // Back link targets the Project Dashboard
        $("#back-to-project")?.setAttribute("href", `./project-dashboard.html?id=${encodeURIComponent(pid)}`);

        const studies = await loadStudies(pid);
        const study = studies.find(s => s.id === sid);
        if (!study) throw new Error("Study not found");

        // Header + key info
        setText("#study-eyebrow", "Study");
        setText("#study-title", study.method || "Study");
        setText("#kv-method", study.method || "");
        setText("#kv-status", study.status || "");
        setText("#kv-studyid", (study.studyId || "").toString().toUpperCase());

        // Description under the title (render Markdown safely)
        let currentMarkdown = mdToAirtableRich(study.description || "");
        setMarkdown("#description", currentMarkdown);

        // Optional “edit” route (placeholder deep-link)
        $("#edit-study")?.setAttribute(
          "href",
          `./study.html?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}#edit`
        );

        // --- Editor wiring ---
        const editor = $("#desc-editor");
        const input  = /** @type {HTMLTextAreaElement} */ ($("#desc-input"));
        const btnEdit = $("#btn-edit-desc");
        const btnCancel = $("#desc-cancel");

        btnEdit?.addEventListener("click", () => {
          input.value = currentMarkdown;
          editor.hidden = false;
          input.focus();
        });

        btnCancel?.addEventListener("click", () => {
          editor.hidden = true;
        });

        editor?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const nextMd = input.value || "";

          // Optimistic preview (normalise + render)
          currentMarkdown = mdToAirtableRich(nextMd);
          setMarkdown("#description", currentMarkdown);
          editor.hidden = true;

          try {
            await patchStudyDescription(sid, nextMd);
          } catch (err) {
            // roll back UI if desired; for now just notify
            console.error(err);
            alert("Saved locally, but failed to persist to Airtable.");
          }
        });

      } catch (err) {
        // eslint-disable-next-line no-console
        console.error(err);
        alert("Could not load study.");
      }
    })();
  </script>
</body>
</html>
