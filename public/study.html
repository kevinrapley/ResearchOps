<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Study — ResearchOps</title>

	<link rel="stylesheet" href="./css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="./css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="./css/screen.css" media="screen" />
	<script type="module" src="./components/layout.js"></script>
</head>

<body>
	<x-include src="./partials/header.html" vars='{
		"active":"Projects",
		"subtitle":"Study"
	}'></x-include>

	<main class="govuk-body" role="main">
		<div class="actions-bar">
			<a id="back-to-project" href="./projects.html" class="btn btn--secondary">← Back to Project</a>
			<!-- placeholder for future study edit -->
			<a id="edit-study" href="#" class="btn">✎ Edit Study</a>
		</div>

		<!-- Hero -->
		<div class="dashboard-hero">
			<p id="study-eyebrow" class="project-org"></p>
			<h1 id="study-title" class="govuk-heading-l">Study</h1>
			<p id="study-subtitle" class="lede"></p>
		</div>

		<!-- Key info -->
		<section class="kv">
			<ul class="kv__list">
				<li><span class="kv__term">Method</span>&nbsp;<span class="kv__desc" id="kv-method">–</span></li>
				<li><span class="kv__term">Status</span>&nbsp;<span class="kv__desc" id="kv-status">–</span></li>
				<li><span class="kv__term">Study ID</span>&nbsp;<span class="kv__desc" id="kv-studyid">–</span></li>
			</ul>
		</section>

		<!-- Materials hubs -->
		<nav class="board" aria-label="Study setup">
			<a href="#" class="board__item" aria-disabled="true">Produce consent forms</a>
			<a href="#" class="board__item" aria-disabled="true">Manage consent</a>
			<a href="#" class="board__item" aria-disabled="true">Schedule participants</a>
			<a href="#" class="board__item" aria-disabled="true">Discussion guides</a>
			<a href="#" class="board__item" aria-disabled="true">Note takers &amp; observers</a>
			<a href="#" class="board__item" aria-disabled="true">Begin a session</a>
		</nav>

		<section class="section">
			<header class="section__header">
				<h2 class="section__title govuk-heading-m">Overview</h2>
			</header>
			<div class="section__body">
				<div class="panel">
					<!-- changed to DIV so we can inject rich HTML safely -->
					<div id="study-description" class="govuk-body">–</div>
				</div>
			</div>
		</section>
	</main>

	<x-include src="./partials/footer.html" vars='{"org":"Home Office Biometrics","build":"ResearchOps v1.0.0 (demo)"}'></x-include>

	<script type="module">
		/**
		 * @file study.bootstrap.js (inline)
		 * @summary Loads one study (by pid+sid) and renders the page (with safe Markdown → HTML).
		 */

		/* ===== helpers ===== */
		const $ = (sel, root = document) => root.querySelector(sel);
		const setText = (sel, value, fallback = "—") => {
			const el = $(sel);
			if (el) el.textContent = (value ?? "").toString().trim() || fallback;
		};

		/**
		 * Escape HTML special chars.
		 * @param {string} s
		 */
		function escapeHtml(s) {
			return String(s)
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;")
				.replace(/'/g, "&#39;");
		}

		/**
		 * Very small Markdown → HTML (headings, lists, links, bold/italic, code)
		 * Assumes input is Airtable rich text (markdown-like).
		 * @param {string} md
		 * @returns {string} (UNSAFE until sanitized)
		 */
		function mdToHtml(md) {
			if (!md) return "";
			let src = md.replace(/\r\n?/g, "\n");

			// code blocks ``` ```
			src = src.replace(/```([\s\S]*?)```/g, (_, code) => {
				return `<pre><code>${escapeHtml(code)}</code></pre>`;
			});

			// headings ####, ###, ##, #
			src = src
				.replace(/^####\s+(.+)$/gm, "<h4>$1</h4>")
				.replace(/^###\s+(.+)$/gm, "<h3>$1</h3>")
				.replace(/^##\s+(.+)$/gm, "<h2>$1</h2>")
				.replace(/^#\s+(.+)$/gm, "<h1>$1</h1>");

			// unordered lists
			// group consecutive -/* lines into a <ul>
			src = src.replace(
				/(?:^(?:-|\*)\s+.+\n?)+/gm,
				(block) => {
					const items = block.trim().split(/\n/).map(l => l.replace(/^(?:-|\*)\s+/, "").trim());
					return `<ul>${items.map(i => `<li>${i}</li>`).join("")}</ul>`;
				}
			);

			// inline code `code`
			src = src.replace(/`([^`]+)`/g, (_, code) => `<code>${escapeHtml(code)}</code>`);

			// bold **text**
			src = src.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");

			// italic *text*
			src = src.replace(/(^|[^\*])\*([^*\n]+)\*(?!\*)/g, "$1<em>$2</em>");

			// links [text](url)
			src = src.replace(/$begin:math:display$([^$end:math:display$]+)\]$begin:math:text$([^)]+)$end:math:text$/g, (m, text, href) => {
				const cleanHref = String(href).trim();
				return `<a href="${cleanHref}">${text}</a>`;
			});

			// paragraphs: split on blank lines, wrap non-blocks
			const blocks = src.split(/\n{2,}/).map(b => b.trim()).filter(Boolean);
			const isBlock = /^(?:<h\d|<ul>|<pre>|<blockquote>|<p>|<table>|<ol>)/i;
			return blocks.map(b => isBlock.test(b) ? b : `<p>${b.replace(/\n/g, "<br>")}</p>`).join("\n");
		}

		/**
		 * Update study description (Markdown) via PATCH.
		 * Sends Markdown string directly to Airtable long-text w/ rich text enabled.
		 */
		async function saveStudyDescription(_pid, sid, markdown) {
			const res = await fetch(`/api/studies/${encodeURIComponent(sid)}`, {
				method: "PATCH",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ description: markdown })
			});
			const js = await res.json().catch(() => ({}));
			if (!res.ok || !js?.ok) {
				throw new Error(js?.error || `PATCH failed (${res.status})`);
			}
			return true;
		}

		(async function bootstrap() {
			try {
				const usp = new URLSearchParams(location.search);
				const pid = usp.get("pid") || "";
				const sid = usp.get("sid") || "";
				if (!pid || !sid) throw new Error("Missing pid or sid");

				$("#back-to-project")?.setAttribute("href", `./project-dashboard.html?id=${encodeURIComponent(pid)}`);

				const studies = await loadStudies(pid);
				const study = studies.find(s => s.id === sid);
				if (!study) throw new Error("Study not found");

				$("#study-eyebrow").textContent = "Study";
				$("#study-title").textContent = study.method || "Study";

				let currentMarkdown = study.description || "";
				setMarkdown("#description", currentMarkdown);

				$("#kv-method").textContent = study.method || "";
				$("#kv-status").textContent = study.status || "";
				$("#kv-studyid").textContent = (study.studyId || "").toString().toUpperCase();

				const editor = $("#desc-editor");
				const input = /** @type {HTMLTextAreaElement} */ ($("#desc-input"));
				const btnEdit = $("#btn-edit-desc");
				const btnCancel = $("#desc-cancel");

				btnEdit?.addEventListener("click", () => {
					input.value = currentMarkdown;
					editor.hidden = false;
					$("#description").hidden = true;
					input.focus();
				});

				btnCancel?.addEventListener("click", () => {
					editor.hidden = true;
					$("#description").hidden = false;
				});

				editor?.addEventListener("submit", async (e) => {
					e.preventDefault();
					const md = input.value || "";

					// optimistic UI
					currentMarkdown = md;
					setMarkdown("#description", md);
					editor.hidden = true;
					$("#description").hidden = false;

					try {
						await saveStudyDescription(pid, sid, md); // real API call
					} catch (err) {
						console.error(err);
						alert("Saved locally, but failed to persist to Airtable.");
					}
				});

				$("#edit-study")?.setAttribute("href",
					`./study.html?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}#edit`);
			} catch (err) {
				console.error(err);
				alert("Could not load study.");
			}
		})();

		/**
		 * Sanitize a subset of HTML tags/attrs.
		 * Allows: p, br, em, strong, h1–h4, ul, ol, li, a[href], code, pre, blockquote.
		 * - Ensures links are http(s) or mailto:
		 * - Adds rel and target to links.
		 * @param {string} html
		 * @returns {string}
		 */
		function sanitize(html) {
			const allowed = new Set(["P", "BR", "EM", "STRONG", "H1", "H2", "H3", "H4", "UL", "OL", "LI", "A", "CODE", "PRE", "BLOCKQUOTE"]);
			const tmp = document.createElement("template");
			tmp.innerHTML = html;

			const walker = document.createTreeWalker(tmp.content, NodeFilter.SHOW_ELEMENT, null);
			/** @type {Element[]} */
			const toRemove = [];

			while (walker.nextNode()) {
				const el = /** @type {Element} */ (walker.currentNode);
				if (!allowed.has(el.tagName)) {
					toRemove.push(el);
					continue;
				}
				if (el.tagName === "A") {
					const href = el.getAttribute("href") || "";
					const ok = /^https?:\/\//i.test(href) || /^mailto:/i.test(href);
					if (!ok) {
						el.removeAttribute("href");
					} else {
						el.setAttribute("rel", "noopener noreferrer");
						el.setAttribute("target", "_blank");
					}
				}
				// strip all other attributes except allowed
				for (const attr of Array.from(el.attributes)) {
					if (el.tagName === "A" && (attr.name === "href" || attr.name === "rel" || attr.name === "target")) continue;
					// no classes/styles to keep it strict; adjust if you later want to allow class
					el.removeAttribute(attr.name);
				}
			}
			for (const el of toRemove) el.replaceWith(document.createTextNode(el.textContent || ""));
			return tmp.innerHTML;
		}

		/**
		 * Render markdown safely into a selector.
		 * @param {string} sel
		 * @param {string} md
		 */
		function setMarkdown(sel, md) {
			const el = $(sel);
			if (!el) return;
			if (!md) { el.textContent = "—"; return; }
			const html = sanitize(mdToHtml(md));
			el.innerHTML = html || "—";
		}

		/**
		 * GET /api/studies?project=<aid>
		 * @param {string} projectId
		 * @returns {Promise<Array<{id:string, studyId?:string, method:string, status?:string, description?:string}>>}
		 */
		async function loadStudies(projectId) {
			const res = await fetch(`/api/studies?project=${encodeURIComponent(projectId)}`, { cache: "no-store" });
			const js = await res.json().catch(() => ({}));
			if (!res.ok || !js?.ok) throw new Error(js?.error || `Studies fetch failed (${res.status})`);
			return js.studies || [];
		}

		(async function bootstrap() {
			try {
				const usp = new URLSearchParams(location.search);
				const pid = usp.get("pid") || "";
				const sid = usp.get("sid") || "";
				if (!pid || !sid) throw new Error("Missing pid or sid");

				// Back link targets the Project Dashboard
				$("#back-to-project")?.setAttribute("href", `./project-dashboard.html?id=${encodeURIComponent(pid)}`);

				const studies = await loadStudies(pid);
				const study = studies.find(s => s.id === sid);
				if (!study) throw new Error("Study not found");

				// Header + key info
				setText("#study-eyebrow", "Study");
				setText("#study-title", study.method || "Study");
				// subtitle shows a plain-text summary (strip markdown)
				const subtitle = (study.description || "").replace(/[`*_>#-]/g, "");
				setText("#study-subtitle", subtitle || "");
				setText("#kv-method", study.method || "");
				setText("#kv-status", study.status || "");
				setText("#kv-studyid", (study.studyId || "").toString().toUpperCase());

				// Rich text description (Markdown → safe HTML)
				setMarkdown("#study-description", study.description || "");

				// Optional “edit” route (placeholder)
				$("#edit-study")?.setAttribute("href", `./study.html?pid=${encodeURIComponent(pid)}&sid=${encodeURIComponent(sid)}#edit`);
			} catch (err) {
				// eslint-disable-next-line no-console
				console.error(err);
				alert("Could not load study.");
			}
		})();
	</script>
</body>

</html>
