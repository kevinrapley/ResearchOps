<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Project Dashboard — ResearchOps</title>

	<link rel="stylesheet" href="./css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="./css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="./css/screen.css" media="screen" />
	<script type="module" src="./components/layout.js"></script>
</head>

<body>
	<!-- Global header -->
	<x-include src="./partials/header.html" vars='{
		"active":"Projects",
		"subtitle":"Project Dashboard"
	}'></x-include>

	<main class="govuk-body" role="main">
		<h1 class="govuk-heading-l" style="margin-top:0">Project Dashboard</h1>

		<nav class="nav" aria-label="secondary actions" style="margin-bottom:16px">
			<a class="govuk-link" href="./projects.html">← Return to Project List</a>
			<a class="govuk-link govuk-brand-background" href="#" id="btn-edit" style="padding:.25rem .5rem; border-radius:4px; margin-left:8px;">Edit Project</a>
		</nav>

		<!-- Hero -->
		<p id="eyebrow-org" class="project-org">Home Office Biometrics</p>
		<h2 id="project-title" class="govuk-heading-l" style="margin-top:0">Untitled project</h2>
		<p id="project-subtitle" class="lede"></p>

		<!-- Key info (Service/Project stages etc.) -->
		<section class="panel" aria-labelledby="info-heading" style="margin:16px 0;">
			<h3 id="info-heading" class="govuk-heading-m">Information</h3>
			<dl class="project-meta" style="margin:0;">
				<div>
					<dt class="label">Service Stage</dt>
					<dd id="kv-service-stage">—</dd>
				</div>
				<div>
					<dt class="label">Project Stage</dt>
					<dd id="kv-project-stage">—</dd>
				</div>
				<div>
					<dt class="label">Organisation Name</dt>
					<dd id="kv-client-name">—</dd>
				</div>
				<div>
					<dt class="label">Lead Researcher</dt>
					<dd id="kv-lead-researcher">—</dd>
				</div>
				<div>
					<dt class="label">Lead Researcher Email</dt>
					<dd id="kv-lead-email">—</dd>
				</div>
			</dl>
		</section>

		<!-- Sublink Button Board -->
		<nav aria-label="Project sections" class="tabs" style="margin-bottom:16px">
			<a class="govuk-link" href="#journal">Reflexive Journal</a>
			<a class="govuk-link" href="#stakeholders">Stakeholder Management</a>
			<a class="govuk-link" href="#planning">Research Planning</a>
			<a class="govuk-link" href="#outcomes">Research Outcomes</a>
		</nav>

		<!-- Stakeholder section -->
		<section id="stakeholders" class="panel" aria-labelledby="stakeholders-heading" style="margin-bottom:16px;">
			<h2 id="stakeholders-heading" class="govuk-heading-m">Stakeholder Management</h2>
			<p class="lede">Keep track of people involved and why they matter to the project.</p>

			<div class="grid">
				<div class="panel">
					<h3 class="govuk-heading-s">Stakeholders</h3>
					<ul id="stakeholders-list" role="list">
						<li class="lede">No stakeholders yet.</li>
					</ul>
					<button class="govuk-button" type="button">+ Add Stakeholder</button>
				</div>

				<div class="panel">
					<h3 class="govuk-heading-s">Objectives</h3>
					<ul id="objectives-list" role="list">
						<li class="lede">No objectives yet.</li>
					</ul>
					<button class="govuk-button" type="button">+ Add Objective</button>
				</div>
			</div>
		</section>

		<!-- Research planning section -->
		<section id="planning" class="panel" aria-labelledby="planning-heading" style="margin-bottom:16px;">
			<h2 id="planning-heading" class="govuk-heading-m">Research Planning</h2>
			<div class="grid">
				<div class="panel">
					<h3 class="govuk-heading-s">User Groups</h3>
					<ul id="user-groups-list" role="list">
						<li class="lede">No user groups yet.</li>
					</ul>
					<button class="govuk-button" type="button">+ Add User Group</button>
				</div>

				<div class="panel">
					<h3 class="govuk-heading-s">Participants</h3>
					<ul id="participants-list" role="list">
						<li class="lede">No participants yet.</li>
					</ul>
					<button class="govuk-button" type="button">+ Add Participant</button>
					<div class="note" aria-live="polite" style="margin-top:8px;">Bulk upload participants via CSV</div>
				</div>
			</div>
		</section>

		<!-- Research outcomes section -->
		<section id="outcomes" class="panel" aria-labelledby="outcomes-heading" style="margin-bottom:16px;">
			<h2 id="outcomes-heading" class="govuk-heading-m">Research Outcomes</h2>

			<div class="grid">
				<div class="panel">
					<h3 class="govuk-heading-s">Studies</h3>
					<ul id="studies-list" role="list">
						<li class="lede">No studies yet.</li>
					</ul>
					<!-- The ONE AND ONLY Add Study trigger -->
					<button id="btn-add-study" class="govuk-button" type="button">+ Add Study</button>
				</div>

				<div class="panel">
					<h3 class="govuk-heading-s">Insights</h3>
					<ul id="insights-list" role="list">
						<li class="lede">No insights yet.</li>
					</ul>
					<button id="btn-add-insight" class="govuk-button" type="button">+ Add Insight</button>
				</div>
			</div>
		</section>

		<!-- Accessible modal dialog: Add Study -->
		<dialog id="study-dialog" aria-labelledby="study-title" aria-describedby="study-desc" aria-modal="true" role="dialog">
			<form method="dialog" style="min-width: min(90vw, 560px);">
				<header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
					<h3 id="study-title" class="govuk-heading-m" style="margin:0;">Add Study</h3>
					<button type="button" class="govuk-link" id="study-close" aria-label="Close add study dialog">✕</button>
				</header>

				<p id="study-desc" class="lede">Create a study and capture the method and a short description.</p>

				<label class="govuk-label" for="study-method">Research Method <span class="govuk-hint">(required)</span></label>
				<select id="study-method" class="govuk-input" required aria-required="true">
					<option value="">Choose something</option>
					<option>Card Sort</option>
					<option>Contextual Inquiry</option>
					<option>Customer Satisfaction Survey</option>
					<option>Diary Study</option>
					<option>Existing Research Analysis</option>
					<option>Expert Review</option>
					<option>Stakeholder Interview</option>
					<option>Survey</option>
					<option>Tree Test</option>
					<option>Usability Test</option>
					<option>User Interview</option>
				</select>

				<div class="note" style="margin:8px 0;">
					Provide a description for the study that is unique and recognisable now and in the future.
				</div>

				<label class="govuk-label" for="study-notes">Study Description <span class="govuk-hint">(required)</span></label>
				<textarea id="study-notes" class="govuk-input" rows="5" required aria-required="true" placeholder="E.g. User interviews with help desk staff, 23/1 – 25/1/25"></textarea>

				<footer style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
					<button class="govuk-button" value="cancel" id="study-cancel" type="button">Cancel</button>
					<button class="govuk-button" value="submit" id="study-submit" type="submit">Submit</button>
				</footer>
			</form>
		</dialog>
	</main>

	<x-include src="./partials/footer.html" vars='{"org":"Home Office Biometrics","build":"ResearchOps v1.0.0 (demo)"}'></x-include>

	<script type="module">
		/* ========= tiny helpers ========= */
		const $ = (sel, root = document) => root.querySelector(sel);
		const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
		const setText = (sel, value, fallback = "—") => { const el = $(sel); if (el) el.textContent = (value ?? "").toString().trim() || fallback; };
		const toMs = (d) => { const n = Date.parse(d); return Number.isFinite(n) ? n : 0; };

		/* ========= data loading ========= */
		async function loadProjects() {
			const res = await fetch("/api/projects", { cache: "no-store" });
			const js = await res.json().catch(() => ({}));
			if (!res.ok || !js?.ok) throw new Error(`Projects fetch failed (${res.status})`);
			return (js.projects || []).map(p => ({
				id: p.id || p.LocalId || p.localId || "",
				localId: p.LocalId || p.localId || "",
				name: p.name || p.Name || "",
				description: p.description || p.Description || "",
				org: p.Org || p.org || "Home Office Biometrics",
				phase: p["rops:servicePhase"] || p.Phase || "",
				status: p["rops:projectStatus"] || p.Status || "",
				objectives: Array.isArray(p.objectives) ? p.objectives : String(p.Objectives ?? p.objectives ?? "").split(/\r?\n/).filter(Boolean),
				user_groups: Array.isArray(p.user_groups) ? p.user_groups : String(p.UserGroups ?? p.user_groups ?? "").split(",").map(s => s.trim()).filter(Boolean),
				stakeholders: Array.isArray(p.stakeholders) ? p.stakeholders : (() => { try { return JSON.parse(p.Stakeholders || "[]"); } catch { return []; } })(),
				createdAt: p.createdAt || p.CreatedAt || p.createdTime || ""
			}));
		}

		function pickProject(projects) {
			const id = new URLSearchParams(location.search).get("id") || "";
			if (!id) return null;
			return projects.find(p => p.id === id || p.localId === id) || null;
		}

		function renderProject(project) {
			setText("#eyebrow-org", project.org, "Home Office Biometrics");
			setText("#project-title", project.name, "Untitled project");
			setText("#project-subtitle", project.description, "");
			setText("#kv-service-stage", project.phase);
			setText("#kv-project-stage", project.status);
			setText("#kv-client-name", project.org);

			// stakeholders
			const st = $("#stakeholders-list");
			if (st) {
				st.innerHTML = project.stakeholders.length ?
					project.stakeholders.map(s => {
						const name = s.name || "";
						const role = s.role ? ` — ${s.role}` : "";
						const email = s.email ? ` <a class="govuk-link" href="mailto:${s.email}">${s.email}</a>` : "";
						return `<li>${name}${role}${email}</li>`;
					}).join("") :
					`<li class="lede">No stakeholders yet.</li>`;
			}

			// objectives
			const obj = $("#objectives-list");
			if (obj) {
				obj.innerHTML = project.objectives.length ?
					project.objectives.map(o => `<li>${o}</li>`).join("") :
					`<li class="lede">No objectives yet.</li>`;
			}

			// user groups
			const ug = $("#user-groups-list");
			if (ug) {
				ug.innerHTML = project.user_groups.length ?
					project.user_groups.map(g => `<li><span class="tag">${g}</span></li>`).join("") :
					`<li class="lede">No user groups yet.</li>`;
			}

			// edit link (placeholder)
			$("#btn-edit")?.setAttribute("href", `./start.html?id=${encodeURIComponent(project.id)}`);
		}

		/* ========= accessible modal (Add Study) ========= */
		(function initStudyModal() {
			const dialog = $("#study-dialog");
			const openBtn = $("#btn-add-study");
			const closeBtn = $("#study-close");
			const cancelBtn = $("#study-cancel");
			const submitBtn = $("#study-submit");
			let lastFocus = null;

			if (!dialog || !openBtn) return;

			function open() {
				lastFocus = document.activeElement;
				dialog.showModal();
				dialog.setAttribute("aria-hidden", "false");
				// focus first input
				$("#study-method")?.focus();
				// inert background for SRs
				document.documentElement.classList.add("modal-open");
			}

			function close() {
				dialog.close();
				dialog.setAttribute("aria-hidden", "true");
				document.documentElement.classList.remove("modal-open");
				if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
			}

			// Basic focus trap
			dialog.addEventListener("keydown", (e) => {
				if (e.key === "Escape") { e.preventDefault();
					close(); return; }
				if (e.key !== "Tab") return;
				const f = $$(
					'a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])',
					dialog
				).filter(el => el.offsetParent !== null);
				if (!f.length) return;
				const first = f[0],
					last = f[f.length - 1];
				if (e.shiftKey && document.activeElement === first) { last.focus();
					e.preventDefault(); } else if (!e.shiftKey && document.activeElement === last) { first.focus();
					e.preventDefault(); }
			});

			// click outside (backdrop) closes
			dialog.addEventListener("click", (e) => {
				const rect = dialog.getBoundingClientRect();
				const inDialog = (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom);
				if (!inDialog) close();
			});

			openBtn.addEventListener("click", open);
			closeBtn?.addEventListener("click", close);
			cancelBtn?.addEventListener("click", close);

			// Trivial submit handler (extend later)
			dialog.addEventListener("close", () => {
				// noop for now
			});
			submitBtn?.addEventListener("click", (e) => {
				// Validate
				const method = $("#study-method")?.value?.trim();
				const notes = $("#study-notes")?.value?.trim();
				if (!method || !notes) { e.preventDefault(); return; }
				// In a later phase, POST to your API here
				close();
			});
		})();

		/* ========= bootstrap ========= */
		(async () => {
			try {
				const projects = await loadProjects();
				projects.sort((a, b) => toMs(b.createdAt) - toMs(a.createdAt));
				const project = pickProject(projects);
				if (!project) throw new Error("Project not found from id param");
				renderProject(project);
			} catch (err) {
				console.error(err);
				alert("Could not load project.");
			}
		})();
	</script>
</body>

</html>
