<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Project Dashboard — ResearchOps</title>

	<!-- Your existing foundations -->
	<link rel="stylesheet" href="./css/govuk/govuk-typography.css" media="screen" />
	<link rel="stylesheet" href="./css/govuk/govuk-colours.css" media="screen" />
	<link rel="stylesheet" href="./css/screen.css" media="screen" />
	<script type="module" src="./components/layout.js"></script>
</head>

<body>
	<!-- Global header -->
	<x-include src="./partials/header.html" vars='{
		"active":"Projects",
		"subtitle":"Project Dashboard"
	}'></x-include>

	<main class="govuk-body" role="main">

		<!-- Hero -->
		<div class="dashboard-hero">
			<p id="eyebrow-org" class="project-org"></p>
			<h1 id="project-title" class="govuk-heading-l"></h1>
			<p id="project-subtitle" class="lede"></p>
		</div>

		<!-- Top actions -->
		<div class="actions-bar">
			<a href="./projects.html" class="btn btn--secondary">← Return to Project List</a>
			<a href="./edit-project.html" class="btn">✎ Edit Project</a>
		</div>

		<!-- Key information -->
		<section class="kv">
			<ul class="kv__list">
				<li><span class="kv__term">Service Stage</span> <span class="kv__desc">Discovery</span></li>
				<li><span class="kv__term">Project Stage</span> <span class="kv__desc">Planning research</span></li>
				<li><span class="kv__term">Client Name</span> <span class="kv__desc">–</span></li>
				<li><span class="kv__term">Lead Researcher</span> <span class="kv__desc">–</span></li>
				<li><span class="kv__term">Lead Researcher Email</span> <span class="kv__desc">–</span></li>
			</ul>
		</section>

		<!-- Sublink Button Board -->
		<nav class="board">
			<a href="#" class="board__item">Reflexive Journal</a>
			<a href="#stakeholders" class="board__item">Stakeholder Management</a>
			<a href="#planning" class="board__item">Research Planning</a>
			<a href="#outcomes" class="board__item">Research Outcomes</a>
		</nav>

		<!-- Stakeholder Section -->
		<section id="stakeholders" class="section">
			<header class="section__header">
				<h2 class="section__title govuk-heading-m">Stakeholder Management</h2>
				<a href="#" class="btn btn--outline">+ Add Stakeholder</a>
			</header>
			<div class="section__body section__grid">
				<div>
					<h3 class="govuk-heading-s">Stakeholders</h3>
					<ul class="list-unstyled list-divided">
						<li>No stakeholders yet.</li>
					</ul>
				</div>
				<div>
					<h3 class="govuk-heading-s">Objectives</h3>
					<ul class="list-unstyled list-divided">
						<li>Objective 1</li>
						<li>Objective 2</li>
						<li>Objective 3</li>
					</ul>
					<a href="#" class="btn btn--outline">+ Add Objective</a>
				</div>
			</div>
		</section>

		<!-- Research Planning Section -->
		<section id="planning" class="section">
			<header class="section__header">
				<h2 class="section__title govuk-heading-m">Research Planning</h2>
			</header>
			<div class="section__body section__grid">
				<div>
					<h3 class="govuk-heading-s">User Groups</h3>
					<ul class="list-unstyled list-divided">
						<li>No user groups yet.</li>
					</ul>
					<a href="#" class="btn btn--outline">+ Add User Group</a>
				</div>
				<div>
					<h3 class="govuk-heading-s">Participants</h3>
					<ul class="list-unstyled list-divided">
						<li>No participants yet.</li>
					</ul>
					<a href="#" class="btn btn--outline">+ Add Participant</a>
					<div class="dropzone">
						<p>Bulk upload participants via CSV</p>
						<input type="file" accept=".csv">
					</div>
				</div>
			</div>
		</section>

		<!-- Research Outcomes Section -->
		<section id="outcomes" class="section">
			<header class="section__header">
				<h2 class="section__title govuk-heading-m">Research Outcomes</h2>
			</header>
			<div class="section__body section__grid">
				<div>
					<h3 class="govuk-heading-s">Studies</h3>
					<ul class="list-unstyled list-divided">
						<li>No studies yet.</li>
					</ul>
					<a href="#" class="btn btn--outline">+ Add Study</a>
				</div>
				<div>
					<h3 class="govuk-heading-s">Insights</h3>
					<ul class="list-unstyled list-divided">
						<li>No insights yet.</li>
					</ul>
					<a href="#" class="btn btn--outline">+ Add Insight</a>
				</div>
			</div>
		</section>

		<section id="research-outcomes" class="dashboard-section">
			<h2 class="govuk-heading-m">Research Outcomes</h2>
			<div class="outcome-actions">
				<button id="btn-add-study" class="govuk-button">+ Add Study</button>
				<button id="btn-add-insight" class="govuk-button">+ Add Insight</button>
			</div>
			<div id="studies-list" class="cluster">
				<p class="lede">No studies yet.</p>
			</div>
		</section>

		<!-- Modal -->
		<dialog id="study-dialog" class="modal">
			<form method="dialog" id="study-form">
				<h3 class="govuk-heading-m">Add Study</h3>

				<label for="research-method" class="govuk-label">Research Method</label>
				<select id="research-method" name="method" class="govuk-select" required>
					<option value="">Choose something</option>
					<option>Card Sort</option>
					<option>Contextual Inquiry</option>
					<option>Customer Satisfaction Survey</option>
					<option>Diary Study</option>
					<option>Existing Research Analysis</option>
					<option>Expert Review</option>
					<option>Stakeholder Interview</option>
					<option>Survey</option>
					<option>Tree Test</option>
					<option>Usability Test</option>
					<option>User Interview</option>
				</select>

				<label for="study-description" class="govuk-label">Study Description</label>
				<textarea id="study-description" name="description" class="govuk-textarea" placeholder="E.g. User interviews with help desk staff, 23/1 – 25/1/23" required></textarea>

				<div class="modal-actions">
					<button type="submit" class="govuk-button">Submit</button>
					<button type="reset" class="govuk-button govuk-button--secondary" formmethod="dialog">Cancel</button>
				</div>
			</form>
		</dialog>

	</main>

	<x-include src="./partials/footer.html" vars='{"org":"Home Office Biometrics","build":"ResearchOps v1.0.0 (demo)"}'></x-include>

	<script type="module">
		// tiny helpers
		const $ = (sel) => document.querySelector(sel);
		const $$ = (sel) => Array.from(document.querySelectorAll(sel));
		const setText = (sel, value, fallback = "—") => {
			const el = $(sel);
			if (el) el.textContent = (value ?? "").toString().trim() || fallback;
		};

		function toMs(d) {
			const n = Date.parse(d);
			return Number.isFinite(n) ? n : 0;
		}

		// fetch projects from the Worker and map into a consistent shape
		async function loadProjects() {
			const res = await fetch("/api/projects", { cache: "no-store" });
			const js = await res.json().catch(() => ({}));
			if (!res.ok || !js?.ok) throw new Error(`Projects fetch failed (${res.status})`);
			return (js.projects || []).map(p => ({
				id: p.id || p.LocalId || p.localId || "",
				localId: p.LocalId || p.localId || "",
				name: p.name || p.Name || "",
				description: p.description || p.Description || "",
				org: p.Org || p.org || "Home Office Biometrics",
				phase: p["rops:servicePhase"] || p.Phase || "",
				status: p["rops:projectStatus"] || p.Status || "",
				objectives: Array.isArray(p.objectives) ? p.objectives : String(p.Objectives ?? p.objectives ?? "").split(/\r?\n/).filter(Boolean),
				user_groups: Array.isArray(p.user_groups) ? p.user_groups : String(p.UserGroups ?? p.user_groups ?? "").split(",").map(s => s.trim()).filter(Boolean),
				stakeholders: Array.isArray(p.stakeholders) ? p.stakeholders : (() => { try { return JSON.parse(p.Stakeholders || "[]"); } catch { return []; } })(),
				createdAt: p.createdAt || p.CreatedAt || p.createdTime || ""
			}));
		}

		// choose project by ?id=… (matches LocalId or Airtable id)
		function pickProject(projects) {
			const id = new URLSearchParams(location.search).get("id") || "";
			if (!id) return null;
			return projects.find(p => p.id === id || p.localId === id) || null;
		}

		// populate the page
		function renderProject(project) {
			// hero
			setText("#eyebrow-org", project.org, "Home Office Biometrics");
			setText("#project-title", project.name, "Untitled project");
			setText("#project-subtitle", project.description, "");

			// key/value info
			setText("#kv-service-stage", project.phase);
			setText("#kv-project-stage", project.status);

			// user groups list (if present)
			const ug = $("#user-groups-list");
			if (ug) {
				ug.innerHTML = project.user_groups.length ?
					project.user_groups.map(g => `<li><span class="tag">${g}</span></li>`).join("") :
					`<li class="lede">No user groups yet.</li>`;
			}

			// objectives list (if present)
			const obj = $("#objectives-list");
			if (obj) {
				obj.innerHTML = project.objectives.length ?
					project.objectives.map(o => `<li>${o}</li>`).join("") :
					`<li class="lede">No objectives yet.</li>`;
			}
		}

		// ================
		// Accessible dialog
		// ================
		function initStudyDialog() {
			const dialog = /** @type {HTMLDialogElement|null} */ ($("#study-dialog"));
			const openBtn = $("#btn-add-study");
			const form = $("#study-form");
			const list = $("#studies-list");
			const pageRoot = $("main") || document.body;

			if (!dialog || !openBtn || !form || !list) return;

			// Ensure ARIA hooks exist (robust if missing in HTML)
			dialog.setAttribute("role", "dialog");
			dialog.setAttribute("aria-modal", "true");
			if (!dialog.getAttribute("aria-labelledby")) {
				const title = dialog.querySelector("h3");
				if (title && !title.id) title.id = "study-dialog-title";
				if (title) dialog.setAttribute("aria-labelledby", title.id);
			}

			let lastActive = null;

			function focusableWithin(el) {
				const selectors = [
					'a[href]', 'button:not([disabled])', 'input:not([disabled])',
					'select:not([disabled])', 'textarea:not([disabled])',
					'[tabindex]:not([tabindex="-1"])'
				];
				return Array.from(el.querySelectorAll(selectors.join(',')))
					.filter(n => n.offsetParent !== null || el === n); // visible-ish
			}

			function trapTab(e) {
				if (!dialog.open || e.key !== "Tab") return;
				const f = focusableWithin(dialog);
				if (!f.length) return;
				const first = f[0],
					last = f[f.length - 1];
				if (e.shiftKey && document.activeElement === first) {
					last.focus();
					e.preventDefault();
				} else if (!e.shiftKey && document.activeElement === last) {
					first.focus();
					e.preventDefault();
				}
			}

			function open() {
				lastActive = document.activeElement;
				// hide the rest of the page for AT; lock scroll
				pageRoot.setAttribute("aria-hidden", "true");
				document.body.style.overflow = "hidden";

				if (typeof dialog.showModal === "function") {
					dialog.showModal();
				} else {
					// very old Safari fallback
					dialog.setAttribute("open", "");
				}
				// focus the first field
				const firstInput = dialog.querySelector("select, textarea, input, button");
				(firstInput || dialog).focus();
				dialog.addEventListener("keydown", trapTab);
			}

			function close() {
				dialog.removeEventListener("keydown", trapTab);
				if (dialog.open && typeof dialog.close === "function") dialog.close();
				dialog.removeAttribute("open");
				pageRoot.removeAttribute("aria-hidden");
				document.body.style.overflow = "";
				if (lastActive && typeof lastActive.focus === "function") {
					lastActive.focus();
				} else {
					openBtn.focus();
				}
			}

			// open + close wiring
			openBtn.addEventListener("click", () => open());
			dialog.addEventListener("cancel", (e) => { e.preventDefault();
				close(); }); // Esc
			dialog.addEventListener("click", (e) => {
				// click on the backdrop closes (only for native <dialog>)
				if (e.target === dialog) close();
			});
			dialog.querySelectorAll('[formmethod="dialog"], [data-close-dialog]').forEach(btn => {
				btn.addEventListener("click", () => close());
			});

			// submit -> append to list (UI only)
			form.addEventListener("submit", (e) => {
				e.preventDefault();
				/** @type {HTMLSelectElement} */
				const methodEl = form.querySelector('#research-method');
				/** @type {HTMLTextAreaElement} */
				const descEl = form.querySelector('#study-description');
				const method = methodEl?.value.trim();
				const desc = descEl?.value.trim();
				if (!method || !desc) return;

				const item = document.createElement("div");
				item.className = "note";
				item.innerHTML = `<strong>${method}</strong><br>${desc}`;
				list.appendChild(item);

				form.reset();
				close();
			});
		}

		(async () => {
			try {
				const projects = await loadProjects();
				projects.sort((a, b) => toMs(b.createdAt) - toMs(a.createdAt));
				const project = pickProject(projects);
				if (!project) throw new Error("Project not found from id param");
				renderProject(project);

				// once content is on the page, wire the dialog
				initStudyDialog();
			} catch (err) {
				console.error(err);
				alert("Could not load project.");
			}
		})();
	</script>
</body>

</html>
